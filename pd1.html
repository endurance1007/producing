<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏßÄÌòúÏùò Ïö© | Í∞ÅÏÉâ ÏõåÌÅ¨Ïä§ÌÖåÏù¥ÏÖò v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .hl-dialog { color: #60a5fa; font-weight: 600; }
        .hl-sfx { color: #fbbf24; font-style: italic; }
        .card-anim { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        [contenteditable]:focus { outline: none; background: rgba(59, 130, 246, 0.03); }
        .memo-input { background: transparent; border-bottom: 1px solid #333; font-size: 11px; padding: 2px 0; color: #aaa; width: 100%; outline: none; }
        .memo-input:focus { border-bottom-color: #2563eb; color: #fff; }
    </style>
</head>
<body class="bg-[#050505] text-gray-200 h-screen overflow-hidden flex flex-col font-sans">

    <header class="h-14 border-b border-white/10 flex items-center justify-between px-6 bg-[#080808] shrink-0">
        <div class="flex items-center gap-3">
            <span class="text-2xl">üê≤</span>
            <h1 class="font-black tracking-tighter text-blue-500 uppercase">Dragon Adapter <span class="text-gray-600 font-light ml-2 text-xs">v4.0</span></h1>
        </div>
        <div class="flex gap-2">
            <button onclick="saveToLocal()" class="px-4 py-1.5 rounded-full border border-gray-700 text-[11px] font-bold hover:bg-gray-800 transition">ÏûÑÏãú Ï†ÄÏû•</button>
            <button onclick="exportToNotion()" class="px-4 py-1.5 rounded-full bg-blue-600 text-white text-[11px] font-bold hover:bg-blue-500 transition">ÎÖ∏ÏÖò ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden">
        
        <section class="w-1/4 flex flex-col border-r border-white/5 bg-[#080808]">
            <div class="p-3 bg-white/5 text-[9px] uppercase tracking-widest text-gray-500 font-bold">Source Script</div>
            <textarea id="sourceInput" 
                      class="flex-1 bg-transparent p-6 outline-none resize-none leading-relaxed text-gray-500 focus:text-gray-400 text-sm border-none"
                      placeholder="ÏõêÏûë ÌÖçÏä§Ìä∏Î•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî..."></textarea>
            <button onclick="parseSource()" class="m-4 py-2 bg-gray-800 hover:bg-gray-700 rounded text-xs font-bold transition">Ï¥àÍ∏∞ Î∂ÑÌï¥ Ïã§Ìñâ</button>
        </section>

        <section class="flex-1 flex flex-col">
            <div class="p-3 bg-black/40 text-[9px] uppercase tracking-widest text-blue-500 font-bold flex justify-between items-center">
                <span>Adapter Board (Cut System)</span>
                <span id="panelCount">0 Cuts</span>
            </div>
            
            <div id="panelContainer" class="flex-1 overflow-y-auto p-10 space-y-8 max-w-4xl mx-auto w-full">
                </div>
        </section>

    </main>

    <script>
        const sourceInput = document.getElementById('sourceInput');
        const panelContainer = document.getElementById('panelContainer');
        const panelCountDisplay = document.getElementById('panelCount');

        function highlightText(text) {
            text = text.replace(/(["'])(?:(?=(\\?))\2.)*?\1/g, '<span class="hl-dialog">$&</span>');
            text = text.replace(/[\(\[][Í∞Ä-Ìû£a-zA-Z\s]+[\)\]]/g, '<span class="hl-sfx">$&</span>');
            return text;
        }

        function parseSource() {
            const text = sourceInput.value.trim();
            if (!text) return;
            const sentences = text.split(/(?<=[.!?])\s+/).filter(s => s.length > 0);
            renderPanels(sentences);
        }

        function renderPanels(sentences) {
            panelContainer.innerHTML = '';
            sentences.forEach(s => createCard(s));
            updateStats();
        }

        function createCard(text, referenceNode = null) {
            const card = document.createElement('div');
            card.className = 'card-anim bg-[#0d0d0d] border border-white/5 rounded-xl p-6 hover:border-white/10 transition-all group relative';
            
            card.innerHTML = `
                <div class="flex flex-col gap-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-mono text-blue-900 font-bold cut-num">Cut 00</span>
                        <div class="flex gap-4 opacity-30 group-hover:opacity-100 transition-opacity">
                            <label class="flex items-center gap-1 text-[10px] cursor-pointer hover:text-blue-400">
                                <input type="checkbox" onchange="toggleMemo(this, 'angle')" class="hidden"> ÏïµÍ∏Ä
                            </label>
                            <label class="flex items-center gap-1 text-[10px] cursor-pointer hover:text-blue-400">
                                <input type="checkbox" onchange="toggleMemo(this, 'shot')" class="hidden"> ÏÉ∑
                            </label>
                            <label class="flex items-center gap-1 text-[10px] cursor-pointer hover:text-blue-400">
                                <input type="checkbox" onchange="toggleMemo(this, 'bg')" class="hidden"> Î∞∞Í≤Ω
                            </label>
                            <button onclick="triggerImage(this)" class="text-[10px] hover:text-green-400 uppercase font-bold">Ïù¥ÎØ∏ÏßÄ+</button>
                        </div>
                    </div>

                    <div class="flex gap-6">
                        <div class="image-slot hidden w-32 shrink-0 relative aspect-[3/4] bg-black rounded border border-white/5 overflow-hidden">
                            <img src="" class="w-full h-full object-cover">
                            <button onclick="removeImage(this)" class="absolute top-1 right-1 bg-black/70 text-white text-[8px] w-4 h-4 flex items-center justify-center rounded-full hover:bg-red-600">X</button>
                        </div>

                        <div class="flex-1 space-y-4">
                            <div class="memo-area flex flex-wrap gap-x-4 gap-y-2"></div>
                            
                            <div class="content-area text-[15px] leading-relaxed text-gray-300 outline-none min-h-[1em]" 
                                 contenteditable="true" 
                                 onpaste="handlePaste(event, this)">
                                ${highlightText(text)}
                            </div>

                            <div class="flex justify-between items-center pt-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                <div class="flex gap-4">
                                    <button onclick="mergeUp(this)" class="text-[9px] text-gray-600 hover:text-blue-400 font-bold uppercase tracking-tighter">Merge Up</button>
                                    <button onclick="splitAtCursor(this)" class="text-[9px] text-gray-600 hover:text-yellow-400 font-bold uppercase tracking-tighter">Split at Cursor</button>
                                </div>
                                <button onclick="this.closest('.group').remove(); updateStats();" class="text-[9px] text-red-900 hover:text-red-500 font-bold">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (referenceNode) panelContainer.insertBefore(card, referenceNode.nextSibling);
            else panelContainer.appendChild(card);
            
            card.querySelector('.content-area').addEventListener('blur', function() {
                this.innerHTML = highlightText(this.innerText);
            });
            updateStats();
        }

        // 1. Ïª§ÏÑú ÏúÑÏπò Î∂ÑÌï† Î°úÏßÅ
        function splitAtCursor(btn) {
            const card = btn.closest('.group');
            const contentArea = card.querySelector('.content-area');
            
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const preRange = range.cloneRange();
            preRange.selectNodeContents(contentArea);
            preRange.setEnd(range.endContainer, range.endOffset);
            
            const preText = preRange.toString();
            const postText = contentArea.innerText.substring(preText.length);

            contentArea.innerText = preText;
            contentArea.innerHTML = highlightText(preText);
            createCard(postText, card);
        }

        // 2. ÏÑ†ÌÉùÏ†Å Î©îÎ™® Î°úÏßÅ
        function toggleMemo(checkbox, type) {
            const memoArea = checkbox.closest('.group').querySelector('.memo-area');
            if (checkbox.checked) {
                const input = document.createElement('input');
                input.className = 'memo-input max-w-[120px]';
                input.placeholder = `${type.toUpperCase()} ÏûÖÎ†•...`;
                input.dataset.type = type;
                memoArea.appendChild(input);
                checkbox.parentElement.classList.add('text-blue-500', 'opacity-100');
            } else {
                const input = memoArea.querySelector(`input[data-type="${type}"]`);
                if (input) input.remove();
                checkbox.parentElement.classList.remove('text-blue-500');
            }
        }

        // 3. Ctrl+V Ïù¥ÎØ∏ÏßÄ Î∂ôÏó¨ÎÑ£Í∏∞ Î∞è Ìï∏Îì§ÎßÅ
        function handlePaste(e, element) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.kind === 'file') {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const slot = element.closest('.group').querySelector('.image-slot');
                        slot.querySelector('img').src = event.target.result;
                        slot.classList.remove('hidden');
                    };
                    reader.readAsDataURL(blob);
                }
            }
        }

        function triggerImage(btn) {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => {
                    const slot = btn.closest('.group').querySelector('.image-slot');
                    slot.querySelector('img').src = ev.target.result;
                    slot.classList.remove('hidden');
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            input.click();
        }

        function removeImage(btn) {
            const slot = btn.closest('.image-slot');
            slot.querySelector('img').src = '';
            slot.classList.add('hidden');
        }

        function mergeUp(btn) {
            const current = btn.closest('.group');
            const prev = current.previousElementSibling;
            if (prev) {
                const prevArea = prev.querySelector('.content-area');
                prevArea.innerText += " " + current.querySelector('.content-area').innerText;
                prevArea.innerHTML = highlightText(prevArea.innerText);
                current.remove();
                updateStats();
            }
        }

        function updateStats() {
            const cards = panelContainer.querySelectorAll('.group');
            panelCountDisplay.innerText = `${cards.length} Cuts`;
            cards.forEach((card, i) => {
                card.querySelector('.cut-num').innerText = `Cut ${String(i + 1).padStart(2, '0')}`;
            });
        }

        function saveToLocal() {
            const data = Array.from(panelContainer.querySelectorAll('.group')).map(card => ({
                text: card.querySelector('.content-area').innerText,
                cut: card.querySelector('.cut-num').innerText
            }));
            localStorage.setItem('dragonAdapter_v4', JSON.stringify(data));
            alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        }

        function exportToNotion() {
            let markdown = `# Í∞ÅÏÉâ ÏõêÍ≥† (${new Date().toLocaleDateString()})\n\n`;
            panelContainer.querySelectorAll('.group').forEach(card => {
                const cut = card.querySelector('.cut-num').innerText;
                const text = card.querySelector('.content-area').innerText;
                const memos = Array.from(card.querySelectorAll('.memo-input')).map(i => `[${i.dataset.type}: ${i.value}]`).join(' ');
                markdown += `### ${cut} ${memos}\n${text}\n\n`;
            });
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Dragon_Cut_Export.md`;
            a.click();
        }
    </script>
</body>
</html>
