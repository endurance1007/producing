<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Engine v5.0 : Complete Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 5px; border: 2px solid #0f172a; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .input-dark { 
            display: block;
            width: 100%;
            background-color: #1f2937 !important; /* ê°•ì œ ë‹¤í¬ */
            color: #e2e8f0 !important;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 1rem;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-top: 0.5rem;
            resize: none;
            overflow: hidden;
            transition: all 0.2s;
        }
        .input-dark:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: #111827 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .input-dark::placeholder {
            color: #4b5563;
            font-style: italic;
        }

        /* í•­ëª© ì œëª©(Label) ìŠ¤íƒ€ì¼ - ìˆ˜ì • ê°€ëŠ¥ */
        .label-editable {
            width: 100%;
            background: transparent;
            border: none;
            font-weight: 800;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.1rem;
            cursor: text;
        }
        .label-editable:focus {
            outline: none;
            border-bottom: 1px dashed #60a5fa;
        }

        /* ì„¤ëª… í…ìŠ¤íŠ¸ */
        .desc-text {
            font-size: 0.75rem;
            color: #94a3b8; /* Slate-400 */
            margin-bottom: 0.5rem;
            display: block;
        }
        
        /* ì„¹ì…˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .section-card { 
            background-color: #1e293b; /* Slate-800 */
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            border: 1px solid #334155; 
            margin-bottom: 2rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* ìºë¦­í„° ë±ìš© ì…ë ¥ì°½ */
        .input-char {
            width: 100%;
            background-color: #0f172a !important;
            color: #cbd5e1;
            border: 1px solid #334155;
            border-radius: 0.25rem;
            padding: 0.5rem;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        .input-char::placeholder { color: #475569; }
        .label-char { font-size: 0.7rem; color: #64748b; font-weight: bold; text-transform: uppercase; margin-top: 0.5rem; display: block; }

    </style>
</head>
<body class="bg-slate-950 text-slate-300 font-sans h-screen flex overflow-hidden">

    <main class="flex-1 overflow-y-auto relative p-8 md:p-20 scroll-smooth" id="main-scroll">
        
        <div class="flex justify-between items-end mb-16 border-b border-slate-800 pb-6">
            <div>
                <h1 class="text-4xl font-black text-white tracking-tight mb-2">Story Engine <span class="text-blue-500">v5.0</span></h1>
                <p class="text-slate-500">The Complete Architect</p>
            </div>
            <div class="flex gap-3">
                <button onclick="exportData()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                    ğŸ“¥ ì €ì¥
                </button>
                <button onclick="clearData()" class="text-slate-500 hover:text-red-400 px-4 py-2 transition">
                    ì´ˆê¸°í™”
                </button>
            </div>
        </div>

        <div id="save-status" class="fixed top-8 left-1/2 transform -translate-x-1/2 bg-slate-900 border border-emerald-900 text-emerald-500 px-4 py-1.5 rounded-full text-xs font-mono opacity-0 transition-opacity pointer-events-none shadow-xl z-50">
            âœ… ì €ì¥ ì™„ë£Œ
        </div>

        <div class="mb-20">
            <h2 class="text-2xl font-bold text-white mb-8 flex items-center gap-3">
                <span class="bg-blue-900 text-blue-300 text-xs px-2 py-1 rounded">PART 1</span> 
                ì´ì•¼ê¸°ì˜ ë¼ˆëŒ€ (Concept)
            </h2>
            
            <div class="section-card border-l-4 border-l-blue-500">
                <input type="text" id="lbl_f_logline" class="label-editable text-blue-400" value="1. ì•„ì´ëŸ¬ë‹ˆ ë¡œê·¸ë¼ì¸ (Logline)" oninput="saveLabel(this.id, this.value)">
                <span class="desc-text">ì£¼ì¸ê³µì˜ íŠ¹ì„±ê³¼ ìƒí™©ì´ ëª¨ìˆœë˜ëŠ” ê²°ì •ì  í•œ ë¬¸ì¥</span>
                <textarea id="f_logline" oninput="autoResize(this); saveData()" rows="2" class="input-dark" placeholder="ì˜ˆ: ì‚´ì¸ì„ ì‹«ì–´í•˜ëŠ” ì „ì„¤ì˜ ì²­ë¶€ì—…ìê°€ ìœ¡ì•„ë¥¼ ë§¡ê²Œ ë˜ë©´ì„œ ë²Œì–´ì§€ëŠ” ì´ì•¼ê¸°"></textarea>
            </div>

            <div class="section-card border-l-4 border-l-blue-400">
                <input type="text" id="lbl_f_question" class="label-editable text-blue-300" value="2. í•µì‹¬ ì§ˆë¬¸ (Dramatic Question)" oninput="saveLabel(this.id, this.value)">
                <span class="desc-text">ë…ìê°€ ëê¹Œì§€ ê¶ê¸ˆí•´í• , ì´ì•¼ê¸° ì „ì²´ë¥¼ ê´€í†µí•˜ëŠ” ì§ˆë¬¸</span>
                <textarea id="f_question" oninput="autoResize(this); saveData()" rows="1" class="input-dark" placeholder="ì˜ˆ: ê³¼ì—° ì£¼ì¸ê³µì€ ì •ì²´ë¥¼ ë“¤í‚¤ì§€ ì•Šê³  ì•„ì´ë¥¼ ì§€ì¼œë‚¼ ìˆ˜ ìˆì„ê¹Œ?"></textarea>
            </div>

            <div class="section-card border-l-4 border-l-blue-300">
                <input type="text" id="lbl_f_target" class="label-editable text-blue-200" value="3. íƒ€ê²Ÿ & ì¥ë¥´" oninput="saveLabel(this.id, this.value)">
                <span class="desc-text">ì´ ì´ì•¼ê¸°ë¥¼ ì†Œë¹„í•  ë…ìì¸µê³¼ ì¥ë¥´ì  ë¬¸ë²•</span>
                <textarea id="f_target" oninput="autoResize(this); saveData()" rows="1" class="input-dark" placeholder="ì˜ˆ: 2030 ë‚¨ì„± / ëˆ„ì•„ë¥´ ì½”ë¯¸ë””"></textarea>
            </div>

            <div class="section-card border-l-4 border-l-cyan-400">
                <input type="text" id="lbl_f_hook" class="label-editable text-cyan-300" value="4. ì°¨ë³„í™” í¬ì¸íŠ¸ (The Hook)" oninput="saveLabel(this.id, this.value)">
                <span class="desc-text">ê¸°ì¡´ì˜ ë¹„ìŠ·í•œ ì´ì•¼ê¸°ë“¤ê³¼ ë‹¤ë¥¸ ê²°ì •ì ì¸ 'í•œ ë—'</span>
                <textarea id="f_hook" oninput="autoResize(this); saveData()" rows="1" class="input-dark" placeholder="ì˜ˆ: í‚¬ëŸ¬ê°€ ìœ¡ì•„ìš©í’ˆìœ¼ë¡œ ì‚¬ëŒì„ ì œì••í•¨"></textarea>
            </div>

            <div class="section-card border-l-4 border-l-blue-600 bg-blue-900/10">
                <input type="text" id="lbl_f_theme" class="label-editable text-blue-300" value="23. í…Œë§ˆ (Theme)" oninput="saveLabel(this.id, this.value)">
                <span class="desc-text">ì´ì•¼ê¸°ì˜ ë§ˆì¹¨í‘œ. ê²°êµ­ ì‘ê°€ê°€ í•˜ê³  ì‹¶ì€ ë§.</span>
                <textarea id="f_theme" oninput="autoResize(this); saveData()" rows="1" class="input-dark bg-slate-800" placeholder="ì˜ˆ: ì§„ì •í•œ ê°•í•¨ì€ ì§€í‚¤ëŠ” ê²ƒì—ì„œ ë‚˜ì˜¨ë‹¤."></textarea>
            </div>
        </div>

        <div class="mb-20">
            <h2 class="text-2xl font-bold text-white mb-8 flex items-center gap-3">
                <span class="bg-indigo-900 text-indigo-300 text-xs px-2 py-1 rounded">PART 2</span> 
                ì„¸ê³„ê´€ (World)
            </h2>

            <div class="section-card border-l-4 border-l-indigo-500">
                <input type="text" id="lbl_f_setting" class="label-editable text-indigo-400" value="11. ë°°ê²½ (Setting)" oninput="saveLabel(this.id, this.value)">
                <span class="desc-text">ì‚¬ê±´ì´ ë²Œì–´ì§€ëŠ” ì‹œê°„ì , ê³µê°„ì  ë¬´ëŒ€ì™€ ë¶„ìœ„ê¸°</span>
                <textarea id="f_setting" oninput="autoResize(this); saveData()" rows="1" class="input-dark" placeholder="ì˜ˆ: 2024ë…„ ì„œìš¸, ë¹„ê°€ ê·¸ì¹˜ì§€ ì•ŠëŠ” ìŒìŠµí•œ ë’·ê³¨ëª©"></textarea>
            </div>

            <div class="section-card border-l-4 border-l-indigo-400">
                <input type="text" id="lbl_f_rules" class="label-editable text-indigo-300" value="12. ê·œì¹™ (Rules)" oninput="saveLabel(this.id, this.value)">
                <span class="desc-text">ì´ ì„¸ê³„ì—ì„œ ì ˆëŒ€ ì–´ê¸¸ ìˆ˜ ì—†ëŠ” ë¬¼ë¦¬ì /ì‚¬íšŒì  ë²•ì¹™</span>
                <textarea id="f_rules" oninput="autoResize(this); saveData()" rows="2" class="input-dark" placeholder="ì˜ˆ: ì¡°ì§ì˜ ê·œì¹™ 1ì¡°, ì•„ì´ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠëŠ”ë‹¤."></textarea>
            </div>

            <div class="section-card border-l-4 border-l-violet-400">
                <input type="text" id="lbl_f_statusQuo" class="label-editable text-violet-300" value="13. ì¼ìƒì˜ ë¶•ê´´ ì „ (Status Quo)" oninput="saveLabel(this.id, this.value)">
                <span class="desc-text">ì‚¬ê±´ì´ í„°ì§€ê¸° ì§ì „, ì£¼ì¸ê³µì´ ì˜ìœ„í•˜ë˜ í‰ë²”(í˜¹ì€ ì§€ë£¨)í•œ ì¼ìƒ</span>
                <textarea id="f_statusQuo" oninput="autoResize(this); saveData()" rows="2" class="input-dark" placeholder="ì˜ˆ: í”¼ ëƒ„ìƒˆë¥¼ ì§€ìš°ê¸° ìœ„í•´ ë§¤ì¼ ëª©ìš•íƒ•ì— ê°€ëŠ” ê¸°ê³„ì ì¸ ì‚¶"></textarea>
            </div>
        </div>

        <div class="pb-24">
            <h2 class="text-2xl font-bold text-white mb-8 flex items-center gap-3">
                <span class="bg-purple-900 text-purple-300 text-xs px-2 py-1 rounded">PART 3</span> 
                í”Œë¡¯ì˜ íŒŒë™ (The Plot)
            </h2>

            <div class="space-y-8">
                
                <div class="section-card border-l-4 border-l-sky-500">
                    <input type="text" id="lbl_p_14" class="label-editable text-sky-400" value="14. ë„ì…ë¶€ ì‚¬ê±´ (Inciting Incident)" oninput="saveLabel(this.id, this.value)">
                    <span class="desc-text">ì£¼ì¸ê³µì˜ ì¼ìƒì— ë¶ˆì„ ì§€ë¥´ê³  ê· í˜•ì„ ê¹¨ëœ¨ë¦¬ëŠ” ì‚¬ê±´</span>
                    <textarea id="p_14" oninput="autoResize(this); saveData()" rows="3" class="input-dark" placeholder="ì˜ˆ: ì¡°ì§ ë³´ìŠ¤ê°€ ê°‘ìê¸° ê°“ë‚œì•„ê¸°ë¥¼ ë§¡ê¸°ê³  ì‚¬ë¼ì§„ë‹¤."></textarea>
                </div>

                <div class="section-card border-l-4 border-l-blue-600">
                    <input type="text" id="lbl_p_15" class="label-editable text-blue-400" value="15. íšŒê·€ ë¶ˆê°€ ì§€ì  (Point of No Return)" oninput="saveLabel(this.id, this.value)">
                    <span class="desc-text">ì£¼ì¸ê³µì´ ì‚¬ê±´ì„ ë°›ì•„ë“¤ì´ê³  ìƒˆë¡œìš´ ì„¸ê³„ë¡œ ë°œì„ ë“¤ì´ëŠ” ìˆœê°„</span>
                    <textarea id="p_15" oninput="autoResize(this); saveData()" rows="3" class="input-dark" placeholder="ì˜ˆ: ì•„ì´ë¥¼ ë…¸ë¦¬ëŠ” ì ë“¤ì„ í”¼í•´ ì§‘ì„ íƒœìš°ê³  ë„ë§ì¹œë‹¤."></textarea>
                </div>

                <div class="section-card border-l-4 border-l-indigo-500">
                    <input type="text" id="lbl_p_16" class="label-editable text-indigo-400" value="16. ì‹œë ¨ê³¼ ìƒìŠ¹ (Rising Action)" oninput="saveLabel(this.id, this.value)">
                    <span class="desc-text">ëª©í‘œë¥¼ í–¥í•´ ê°€ë©° ê²ªëŠ” 3~4ê°œì˜ ì ì¸µì ì¸ ì‹œë ¨ë“¤</span>
                    <textarea id="p_16" oninput="autoResize(this); saveData()" rows="4" class="input-dark" placeholder="ì˜ˆ: ê¸°ì €ê·€ë¥¼ êµ¬í•˜ë ¤ë‹¤ ì •ì²´ê°€ íƒ„ë¡œë‚¨ -> ì•”ì‚´ìì˜ ìŠµê²© -> ê²½ì°°ì˜ ì¶”ì "></textarea>
                </div>

                <div class="section-card border-l-4 border-l-purple-500 bg-slate-800 relative overflow-hidden">
                    <div class="absolute right-0 top-0 p-4 opacity-5 text-6xl font-black text-purple-500 pointer-events-none">MID</div>
                    <input type="text" id="lbl_p_17" class="label-editable text-purple-400 text-lg" value="17. ë¯¸ë“œí¬ì¸íŠ¸ (Mid-point)" oninput="saveLabel(this.id, this.value)">
                    <span class="desc-text">ì´ì•¼ê¸°ì˜ í—ˆë¦¬. íŒì´ ë’¤ì§‘íˆê±°ë‚˜ ì£¼ì¸ê³µì´ ê°ì„±í•˜ëŠ” ì§€ì .</span>
                    <textarea id="p_17" oninput="autoResize(this); saveData()" rows="4" class="input-dark border-purple-500/30" placeholder="ì˜ˆ: ì•„ì´ê°€ ë³´ìŠ¤ì˜ ì¹œìì‹ì´ ì•„ë‹ˆë¼ ë‚´ ì•„ì´ì˜€ë‹¤ëŠ” ì‚¬ì‹¤ì„ ì•Œê²Œ ë¨."></textarea>
                </div>

                <div class="section-card border-l-4 border-l-orange-500">
                    <input type="text" id="lbl_p_18" class="label-editable text-orange-400" value="18. íŒëˆ ìƒìŠ¹ (Stakes)" oninput="saveLabel(this.id, this.value)">
                    <span class="desc-text">ì‹¤íŒ¨í–ˆì„ ë•Œ ìƒê²Œ ë˜ëŠ” ê²ƒì´ ì–´ë–»ê²Œ ë” ì»¤ì¡ŒëŠ”ê°€?</span>
                    <textarea id="p_18" oninput="autoResize(this); saveData()" rows="2" class="input-dark" placeholder="ì˜ˆ: ì´ì œëŠ” ë‚´ ëª©ìˆ¨ë¿ ì•„ë‹ˆë¼ ì•„ì´ì˜ ë¯¸ë˜ê¹Œì§€ ê±¸ë ¤ìˆë‹¤."></textarea>
                </div>

                <div class="section-card border-l-4 border-l-red-800 bg-red-900/10">
                    <input type="text" id="lbl_p_19" class="label-editable text-red-400" value="19. íŒ¨ë°° (All is Lost)" oninput="saveLabel(this.id, this.value)">
                    <span class="desc-text">ìµœì•…ì˜ ì ˆë§. í¬ë§ì´ ì—†ì–´ ë³´ì´ëŠ” ìˆœê°„.</span>
                    <textarea id="p_19" oninput="autoResize(this); saveData()" rows="2" class="input-dark border-red-900/50" placeholder="ì˜ˆ: ì•„ì´ë¥¼ ì ì—ê²Œ ëºê¸°ê³  ë™ë£ŒëŠ” ë°°ì‹ í–ˆë‹¤."></textarea>
                </div>

                <div class="section-card border-l-4 border-l-red-600">
                    <input type="text" id="lbl_p_20" class="label-editable text-red-400" value="20. í´ë¼ì´ë§¥ìŠ¤ (Climax)" oninput="saveLabel(this.id, this.value)">
                    <span class="desc-text">ì£¼ì¸ê³µê³¼ ëŒ€ë¦½ìì˜ ìµœí›„ì˜ ì •ë©´ ìŠ¹ë¶€</span>
                    <textarea id="p_20" oninput="autoResize(this); saveData()" rows="3" class="input-dark" placeholder="ì˜ˆ: ì ì˜ ë³¸ê±°ì§€ì— í™€ë¡œ ì¹¨íˆ¬í•˜ì—¬ ìµœì¢… ë³´ìŠ¤ì™€ ëŒ€ê²°í•œë‹¤."></textarea>
                </div>

                <div class="section-card border-l-4 border-l-yellow-500">
                    <input type="text" id="lbl_p_21" class="label-editable text-yellow-400" value="21. ìµœí›„ì˜ ì„ íƒ (The Choice)" oninput="saveLabel(this.id, this.value)">
                    <span class="desc-text">ìŠ¹ë¦¬ë¥¼ ìœ„í•´ ì£¼ì¸ê³µì´ ê¸°êº¼ì´ í¬ìƒí•˜ê±°ë‚˜ í¬ê¸°í•˜ëŠ” ê°€ì¹˜</span>
                    <textarea id="p_21" oninput="autoResize(this); saveData()" rows="2" class="input-dark" placeholder="ì˜ˆ: í‚¬ëŸ¬ë¡œì„œì˜ ëª…ì„±ì„ ë²„ë¦¬ê³  ì•„ì´ë¥¼ ìœ„í•´ ììˆ˜í•œë‹¤."></textarea>
                </div>

                <div class="section-card border-l-4 border-l-emerald-500">
                    <input type="text" id="lbl_p_22" class="label-editable text-emerald-400" value="22. í•´ì†Œ (Resolution)" oninput="saveLabel(this.id, this.value)">
                    <span class="desc-text">ì‚¬ê±´ ì´í›„ ë³€í™”ëœ ì„¸ê³„ì™€ ì£¼ì¸ê³µì˜ ëª¨ìŠµ</span>
                    <textarea id="p_22" oninput="autoResize(this); saveData()" rows="3" class="input-dark" placeholder="ì˜ˆ: ê°ì˜¥ì—ì„œ ì•„ì´ì˜ í¸ì§€ë¥¼ ë°›ìœ¼ë©° ë¯¸ì†Œ ì§“ëŠ” ì£¼ì¸ê³µ."></textarea>
                </div>
            </div>
        </div>
    </main>

    <aside class="w-[450px] bg-slate-900 border-l border-slate-800 flex flex-col shadow-2xl z-20">
        <div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900 shrink-0">
            <h2 class="text-sm font-bold text-slate-100 uppercase tracking-widest flex items-center gap-2">
                ğŸ­ Character Deck
            </h2>
            <button onclick="addCharacter()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded font-bold transition shadow-lg">+ New</button>
        </div>
        
        <div id="character-list" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-950">
            </div>
    </aside>

    <script>
        // === ê¸°ëŠ¥: ì…ë ¥ì°½ ë†’ì´ ìë™ ì¡°ì ˆ ===
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        // === ë°ì´í„° êµ¬ì¡° ===
        let projectData = {
            labels: {}, 
            concept: { logline: "", question: "", target: "", hook: "", theme: "", setting: "", rules: "", statusQuo: "" },
            characters: [], 
            plot: { p14: "", p15: "", p16: "", p17: "", p18: "", p19: "", p20: "", p21: "", p22: "" }
        };

        // === ì´ˆê¸°í™” ===
        window.onload = function() {
            const saved = localStorage.getItem('storyEngineV5');
            if (saved) {
                const parsed = JSON.parse(saved);
                if(!parsed.labels) parsed.labels = {};
                projectData = parsed;
                loadUI();
            } else {
                addCharacter();
            }
        };

        // === ë¼ë²¨/ë°ì´í„° ì €ì¥ ===
        function saveLabel(id, value) {
            projectData.labels[id] = value;
            saveData(false);
        }

        function saveData(resize = true) {
            // Concept
            ['logline', 'question', 'target', 'hook', 'theme', 'setting', 'rules', 'statusQuo'].forEach(id => {
                const el = document.getElementById('f_' + id);
                if(el) projectData.concept[id] = el.value;
            });
            // Plot
            ['p14', 'p15', 'p16', 'p17', 'p18', 'p19', 'p20', 'p21', 'p22'].forEach(id => {
                const el = document.getElementById('p_' + id.replace('p', ''));
                if(el) projectData.plot[id.replace('_','')] = el.value;
            });

            localStorage.setItem('storyEngineV5', JSON.stringify(projectData));
            
            const status = document.getElementById('save-status');
            status.style.opacity = '1';
            setTimeout(() => status.style.opacity = '0', 1000);
        }

        function loadUI() {
            // ë¼ë²¨ ë¡œë“œ
            for (const [key, val] of Object.entries(projectData.labels)) {
                const el = document.getElementById(key);
                if(el) el.value = val;
            }
            // í…ìŠ¤íŠ¸ ë¡œë“œ
            for (const [key, val] of Object.entries(projectData.concept)) {
                const el = document.getElementById('f_' + key);
                if(el) { el.value = val; autoResize(el); }
            }
            for (const [key, val] of Object.entries(projectData.plot)) {
                 const el = document.getElementById('p_' + key.replace('p',''));
                 if(el) { el.value = val; autoResize(el); }
            }
            // ìºë¦­í„° ë¡œë“œ
            const list = document.getElementById('character-list');
            list.innerHTML = '';
            projectData.characters.forEach(c => renderCharacterCard(c));
        }

        // === ìºë¦­í„° ê´€ë¦¬ (Full Enhanced) ===
        function addCharacter() {
            const newChar = {
                id: Date.now(),
                name: "", role: "", color: "#3b82f6",
                // 1. Inner
                want: "", need: "", wound: "", flaw: "", values: "",
                // 2. Function
                position: "", secret: "", skill: "",
                // 3. Visual
                silhouette: "", item: "", habit: "", gap: "",
                // 4. Relations & Arc
                attitude: "", history: "",
                startState: "", catalyst: "", endState: "",
                isExpanded: true
            };
            projectData.characters.push(newChar);
            renderCharacterCard(newChar);
            saveData();
            setTimeout(() => {
                const list = document.getElementById('character-list');
                list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function renderCharacterCard(c) {
            const list = document.getElementById('character-list');
            const card = document.createElement('div');
            card.className = "bg-slate-900 rounded-lg border-l-4 shadow-lg overflow-hidden transition-all duration-200 group border-slate-700 mb-4";
            card.style.borderLeftColor = c.color;

            card.innerHTML = `
                <div class="p-3 bg-slate-900 flex justify-between items-center cursor-pointer border-b border-slate-800 hover:bg-slate-800" onclick="toggleCard(${c.id})">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color:${c.color}"></div>
                        <div>
                            <h3 class="font-bold text-slate-200 text-sm truncate max-w-[200px]">${c.name || 'New Character'}</h3>
                            <p class="text-[10px] text-slate-500 truncate h-3">${c.role || 'Role'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="deleteChar(${c.id}, event)" class="text-slate-600 hover:text-red-400 px-1 text-lg">Ã—</button>
                    </div>
                </div>
                
                <div id="card-body-${c.id}" class="${c.isExpanded ? '' : 'hidden'} p-4 bg-slate-900 border-t border-slate-800">
                    
                    <div class="grid grid-cols-5 gap-2 mb-4">
                        <div class="col-span-3">
                            <label class="label-char">NAME</label>
                            <input value="${c.name}" oninput="updateChar(${c.id}, 'name', this.value)" class="input-char font-bold text-white text-sm" placeholder="ì´ë¦„">
                        </div>
                        <div class="col-span-2">
                             <label class="label-char">COLOR</label>
                             <div class="h-[30px] bg-slate-900 rounded border border-slate-700 flex items-center px-1 mt-1">
                                <input type="color" value="${c.color}" oninput="updateCharColor(${c.id}, this.value, this)" class="w-full h-5 bg-transparent cursor-pointer">
                             </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="label-char">ROLE</label>
                        <input value="${c.role}" oninput="updateChar(${c.id}, 'role', this.value)" class="input-char" placeholder="ì˜ˆ: ì£¼ì¸ê³µ, ë©”ì¸ ë¹ŒëŸ°">
                    </div>

                    <div class="pt-2 border-t border-slate-800 mb-4">
                        <h4 class="text-xs font-bold text-blue-400 mb-2 mt-2">ğŸ§  INNER ENGINE (ë‚´ë©´)</h4>
                        <label class="label-char">WANT (ìš•ë§)</label>
                        <input value="${c.want}" oninput="updateChar(${c.id}, 'want', this.value)" class="input-char" placeholder="ê²‰ìœ¼ë¡œ ì–»ìœ¼ë ¤ëŠ” êµ¬ì²´ì  ëª©í‘œ">
                        
                        <label class="label-char">NEED (ê²°í•)</label>
                        <input value="${c.need}" oninput="updateChar(${c.id}, 'need', this.value)" class="input-char" placeholder="ë‚´ì  ì„±ì¥ì„ ìœ„í•´ ì§„ì§œ í•„ìš”í•œ ê²ƒ">
                        
                        <label class="label-char">WOUND (ìƒì²˜)</label>
                        <input value="${c.wound}" oninput="updateChar(${c.id}, 'wound', this.value)" class="input-char" placeholder="ê³¼ê±°ì˜ íŠ¸ë¼ìš°ë§ˆ">
                        
                        <label class="label-char">FLAW (ê²°í•¨)</label>
                        <input value="${c.flaw}" oninput="updateChar(${c.id}, 'flaw', this.value)" class="input-char" placeholder="ëª©í‘œ ë‹¬ì„±ì„ ë°©í•´í•˜ëŠ” ì„±ê²©ì  ê²°ì ">
                        
                        <label class="label-char">VALUES (ê°€ì¹˜ê´€)</label>
                        <input value="${c.values}" oninput="updateChar(${c.id}, 'values', this.value)" class="input-char" placeholder="ì˜ˆ: ëˆì´ ìµœê³ ë‹¤ vs ì •ì˜ê°€ ë¨¼ì €ë‹¤">
                    </div>

                    <div class="pt-2 border-t border-slate-800 mb-4">
                         <h4 class="text-xs font-bold text-indigo-400 mb-2 mt-2">ğŸ¤« FUNCTION & SECRET</h4>
                         <label class="label-char">POSITION</label>
                         <input value="${c.position}" oninput="updateChar(${c.id}, 'position', this.value)" class="input-char" placeholder="ì„œì‚¬ì  ê¸°ëŠ¥ (ì˜ˆ: ì •ë³´ì›, ë°©í•´ê¾¼)">
                         
                         <label class="label-char">SECRET</label>
                         <input value="${c.secret}" oninput="updateChar(${c.id}, 'secret', this.value)" class="input-char" placeholder="ë‚¨ì—ê²Œ ì ˆëŒ€ ë“¤í‚¤ë©´ ì•ˆ ë˜ëŠ” ë¹„ë°€">
                         
                         <label class="label-char">SKILL</label>
                         <input value="${c.skill}" oninput="updateChar(${c.id}, 'skill', this.value)" class="input-char" placeholder="íŠ¹ê¸°ë‚˜ ëŠ¥ë ¥">
                    </div>

                    <div class="pt-2 border-t border-slate-800 mb-4">
                        <h4 class="text-xs font-bold text-emerald-400 mb-2 mt-2">ğŸ‘ï¸ VISUAL & PERSONA</h4>
                        <label class="label-char">SILHOUETTE</label>
                        <input value="${c.silhouette}" oninput="updateChar(${c.id}, 'silhouette', this.value)" class="input-char" placeholder="ì™¸í˜•ì  íŠ¹ì§•, ì²´í˜•, ìŠ¤íƒ€ì¼">
                        
                        <label class="label-char">ITEM</label>
                        <input value="${c.item}" oninput="updateChar(${c.id}, 'item', this.value)" class="input-char" placeholder="ì‹œê·¸ë‹ˆì²˜ ì•„ì´í…œ">
                        
                        <label class="label-char">HABIT</label>
                        <input value="${c.habit}" oninput="updateChar(${c.id}, 'habit', this.value)" class="input-char" placeholder="ë§ë²„ë¦‡ì´ë‚˜ ì‹ ì²´ì  ìŠµê´€">
                        
                        <label class="label-char">GAP (ë°˜ì „ë§¤ë ¥)</label>
                        <input value="${c.gap}" oninput="updateChar(${c.id}, 'gap', this.value)" class="input-char" placeholder="ì²«ì¸ìƒê³¼ ë‹¤ë¥¸ ì‹¤ì œ ì„±ê²©">
                    </div>

                    <div class="pt-2 border-t border-slate-800 mb-4">
                        <h4 class="text-xs font-bold text-pink-400 mb-2 mt-2">ğŸ¤ RELATIONS</h4>
                        <label class="label-char">ATTITUDE</label>
                        <input value="${c.attitude}" oninput="updateChar(${c.id}, 'attitude', this.value)" class="input-char" placeholder="íƒ€ì¸ì„ ëŒ€í•˜ëŠ” íƒœë„">
                        
                        <label class="label-char">HISTORY</label>
                        <input value="${c.history}" oninput="updateChar(${c.id}, 'history', this.value)" class="input-char" placeholder="ì£¼ìš” ê³¼ê±°ì‚¬ ìš”ì•½">
                    </div>

                     <div class="pt-2 border-t border-slate-800">
                        <h4 class="text-xs font-bold text-orange-400 mb-2 mt-2">ğŸ“ˆ ARC (ì„±ì¥ ê³¡ì„ )</h4>
                        <div class="flex gap-2 items-center">
                            <input value="${c.startState}" oninput="updateChar(${c.id}, 'startState', this.value)" class="input-char" placeholder="Start (ì´ˆë°˜)">
                            <span class="text-slate-500">â†’</span>
                            <input value="${c.catalyst}" oninput="updateChar(${c.id}, 'catalyst', this.value)" class="input-char" placeholder="ê³„ê¸°">
                            <span class="text-slate-500">â†’</span>
                            <input value="${c.endState}" oninput="updateChar(${c.id}, 'endState', this.value)" class="input-char" placeholder="End (ê²°ë§)">
                        </div>
                    </div>
                </div>
            `;
            list.appendChild(card);
        }

        function toggleCard(id) {
            const body = document.getElementById(`card-body-${id}`);
            const char = projectData.characters.find(c => c.id === id);
            body.classList.toggle('hidden');
            if(char) char.isExpanded = !body.classList.contains('hidden');
            saveData(false);
        }

        function updateChar(id, key, val) {
            const idx = projectData.characters.findIndex(c => c.id === id);
            if(idx > -1) {
                projectData.characters[idx][key] = val;
                saveData(false);
                if(key === 'name' || key === 'role') {
                    const cardBody = document.getElementById(`card-body-${id}`);
                    const header = cardBody.previousElementSibling;
                    if(key === 'name') header.querySelector('h3').textContent = val || 'New Character';
                    if(key === 'role') header.querySelector('p').textContent = val || 'Role';
                }
            }
        }

        function updateCharColor(id, color, inputEl) {
            const idx = projectData.characters.findIndex(c => c.id === id);
            if(idx > -1) {
                projectData.characters[idx].color = color;
                const card = inputEl.closest('.group');
                card.style.borderLeftColor = color;
                card.querySelector('.rounded-full').style.backgroundColor = color;
                saveData(false);
            }
        }

        function deleteChar(id, e) {
            e.stopPropagation();
            if(confirm('Delete?')) {
                projectData.characters = projectData.characters.filter(c => c.id !== id);
                saveData(false);
                loadUI();
            }
        }

        function exportData() {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData, null, 2));
            const node = document.createElement('a');
            node.href = str;
            node.download = "story_engine_v5.json";
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        function clearData() {
            if(confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('storyEngineV5');
                location.reload();
            }
        }
    </script>
</body>
</html>
