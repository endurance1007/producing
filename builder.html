<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Engine v3.5 : Refined Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Engine v4.0 : Ultimate Dark</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 5px; border: 2px solid #111827; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ (ì™„ì „í•œ ë‹¤í¬ ëª¨ë“œ & ê°€ë…ì„± ê°œì„ ) */
        .input-dark { 
            @apply block w-full bg-gray-700 text-gray-100 border border-gray-600 rounded-lg px-4 py-3 text-base focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 focus:outline-none placeholder-gray-400 leading-relaxed mt-2 transition-all shadow-sm; 
        }

        /* ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .label-main { @apply block text-sm font-bold uppercase tracking-wide text-blue-400 mb-1; }
        .label-sub { @apply text-xs font-normal text-gray-400 normal-case ml-2; }
        .label-char { @apply block text-[11px] font-bold text-gray-400 mb-1 uppercase tracking-wider; }

        /* ì„¹ì…˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .section-card { @apply bg-gray-800/80 rounded-xl p-6 border border-gray-700 shadow-lg hover:border-gray-600 transition duration-300; }
        
        /* ìºë¦­í„° ì¹´ë“œ ì…ë ¥ì°½ (ì‘ê³  ì´˜ì´˜í•˜ê²Œ) */
        .input-char {
            @apply w-full bg-gray-900 text-gray-200 border border-gray-700 rounded px-2 py-1.5 text-xs focus:border-blue-500 focus:outline-none placeholder-gray-600 mb-2;
        }

    </style>
</head>
<body class="bg-gray-950 text-gray-300 font-sans h-screen flex overflow-hidden selection:bg-blue-500/40">

    <main class="flex-1 overflow-y-auto relative p-8 md:p-16 scroll-smooth" id="main-scroll">
        
        <div class="flex justify-between items-end mb-12 border-b border-gray-800 pb-6">
            <div>
                <h1 class="text-4xl font-black text-white tracking-tight mb-2">Story Engine <span class="text-blue-500">v4.0</span></h1>
                <p class="text-gray-500">Ultimate Dark Edition</p>
            </div>
            <div class="flex gap-3">
                <button onclick="exportData()" class="bg-blue-700 hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                    ğŸ“¥ ì €ì¥í•˜ê¸°
                </button>
                <button onclick="clearData()" class="text-gray-500 hover:text-red-400 px-4 py-2 transition">
                    ì´ˆê¸°í™”
                </button>
            </div>
        </div>

        <div id="save-status" class="fixed top-8 left-1/2 transform -translate-x-1/2 bg-gray-900 border border-green-900 text-green-500 px-4 py-1.5 rounded-full text-xs font-mono opacity-0 transition-opacity pointer-events-none shadow-xl z-50">
            âœ… ì €ì¥ ì™„ë£Œ
        </div>

        <div class="mb-16">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                <span class="bg-blue-900 text-blue-300 text-xs px-2 py-1 rounded">PART 1</span> 
                ì´ì•¼ê¸°ì˜ ë¼ˆëŒ€ (Concept)
            </h2>
            
            <div class="space-y-8">
                <div class="section-card border-l-4 border-l-blue-500">
                    <label class="label-main">1. ì•„ì´ëŸ¬ë‹ˆ ë¡œê·¸ë¼ì¸ <span class="label-sub">ì£¼ì¸ê³µì˜ íŠ¹ì„±ê³¼ ìƒí™©ì´ ëª¨ìˆœë˜ëŠ” í•œ ë¬¸ì¥</span></label>
                    <textarea id="f_logline" oninput="autoResize(this); saveData()" rows="2" class="input-dark text-lg font-medium" placeholder="ì˜ˆ: ì‚´ì¸ì„ ì‹«ì–´í•˜ëŠ” ì²­ë¶€ì—…ìê°€..."></textarea>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="section-card">
                        <label class="label-main">2. í•µì‹¬ ì§ˆë¬¸ <span class="label-sub">Dramatic Question</span></label>
                        <textarea id="f_question" oninput="autoResize(this); saveData()" rows="1" class="input-dark" placeholder="ì£¼ì¸ê³µì€ ê³¼ì—° ~í•  ìˆ˜ ìˆì„ê¹Œ?"></textarea>
                    </div>
                    <div class="section-card border-blue-500/20 bg-blue-900/10">
                        <label class="label-main text-blue-300">23. í…Œë§ˆ <span class="label-sub text-blue-400/50">Controlling Idea</span></label>
                        <textarea id="f_theme" oninput="autoResize(this); saveData()" rows="1" class="input-dark bg-gray-800/50" placeholder="ê²°êµ­ ì´ ì´ì•¼ê¸°ëŠ” ~ì— ê´€í•œ ê²ƒì´ë‹¤."></textarea>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="section-card">
                        <label class="label-main">3. íƒ€ê²Ÿ & ì¥ë¥´</label>
                        <textarea id="f_target" oninput="autoResize(this); saveData()" rows="1" class="input-dark"></textarea>
                    </div>
                    <div class="section-card">
                        <label class="label-main">4. ì°¨ë³„í™” í¬ì¸íŠ¸ (Hook)</label>
                        <textarea id="f_hook" oninput="autoResize(this); saveData()" rows="1" class="input-dark"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-16">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                <span class="bg-indigo-900 text-indigo-300 text-xs px-2 py-1 rounded">PART 2</span> 
                ì„¸ê³„ê´€ (World)
            </h2>
            <div class="grid grid-cols-1 gap-8">
                <div class="section-card">
                    <label class="label-main">11. ë°°ê²½ (Setting)</label>
                    <textarea id="f_setting" oninput="autoResize(this); saveData()" rows="1" class="input-dark" placeholder="ì‹œê°„ì , ê³µê°„ì  ë°°ê²½ê³¼ ë¶„ìœ„ê¸°"></textarea>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="section-card">
                        <label class="label-main">12. ê·œì¹™ (Rules)</label>
                        <textarea id="f_rules" oninput="autoResize(this); saveData()" rows="2" class="input-dark" placeholder="ì´ ì„¸ê³„ì˜ ì œì•½ì´ë‚˜ ë²•ì¹™"></textarea>
                    </div>
                    <div class="section-card">
                        <label class="label-main">13. ì¼ìƒì˜ ë¶•ê´´ ì „</label>
                        <textarea id="f_statusQuo" oninput="autoResize(this); saveData()" rows="2" class="input-dark" placeholder="ì‚¬ê±´ ë°œìƒ ì „ì˜ í‰ë²”í•œ ì¼ìƒ"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="pb-24">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                <span class="bg-purple-900 text-purple-300 text-xs px-2 py-1 rounded">PART 3</span> 
                í”Œë¡¯ì˜ íŒŒë™ (The Plot)
            </h2>

            <div class="space-y-10 pl-4 border-l-2 border-gray-800 ml-2">
                
                <div class="section-card border-l-4 border-l-sky-500">
                    <label class="label-main text-sky-400">14. ë„ì…ë¶€ ì‚¬ê±´ (Inciting Incident)</label>
                    <textarea id="p_14" oninput="autoResize(this); saveData()" rows="3" class="input-dark" placeholder="ì¼ìƒì— ë¶ˆì„ ì§€ë¥´ëŠ” ì‚¬ê±´"></textarea>
                </div>

                <div class="section-card border-l-4 border-l-blue-600">
                    <label class="label-main text-blue-400">15. íšŒê·€ ë¶ˆê°€ ì§€ì  (Point of No Return)</label>
                    <textarea id="p_15" oninput="autoResize(this); saveData()" rows="3" class="input-dark" placeholder="ìƒˆë¡œìš´ ì„¸ê³„ë¡œì˜ ì§„ì…"></textarea>
                </div>

                <div class="section-card border-l-4 border-l-indigo-500">
                    <label class="label-main text-indigo-400">16. ì‹œë ¨ê³¼ ìƒìŠ¹ (Rising Action)</label>
                    <textarea id="p_16" oninput="autoResize(this); saveData()" rows="4" class="input-dark" placeholder="ì ì  ì»¤ì§€ëŠ” ì¥ì• ë¬¼ë“¤"></textarea>
                </div>

                <div class="section-card border-l-4 border-l-purple-500 bg-gray-800 relative overflow-hidden">
                    <div class="absolute right-0 top-0 p-4 opacity-5 text-6xl font-black text-purple-500 pointer-events-none">MID</div>
                    <label class="label-main text-purple-400 text-lg">17. ë¯¸ë“œí¬ì¸íŠ¸ (Mid-point)</label>
                    <p class="text-sm text-gray-500 mb-2">íŒì´ ë’¤ì§‘íˆëŠ” ê±°ëŒ€í•œ ë°˜ì „. ì£¼ì¸ê³µì˜ ê°ì„±.</p>
                    <textarea id="p_17" oninput="autoResize(this); saveData()" rows="4" class="input-dark border-purple-500/30" placeholder="ìˆ˜ë™ì  íƒœë„ì—ì„œ ëŠ¥ë™ì  íƒœë„ë¡œ ë³€í™”"></textarea>
                </div>

                <div class="section-card border-l-4 border-l-orange-500">
                    <label class="label-main text-orange-400">18. íŒëˆ ìƒìŠ¹ & 19. íŒ¨ë°°</label>
                    <div class="space-y-4">
                        <textarea id="p_18" oninput="autoResize(this); saveData()" rows="2" class="input-dark" placeholder="ì‹¤íŒ¨ ì‹œ ìƒëŠ” ê²ƒ (íŒëˆ ìƒìŠ¹)"></textarea>
                        <textarea id="p_19" oninput="autoResize(this); saveData()" rows="2" class="input-dark border-red-900/50 bg-red-900/10" placeholder="ëª¨ë“  ê²ƒì„ ìƒì€ ìˆœê°„ (All is Lost)"></textarea>
                    </div>
                </div>

                <div class="section-card border-l-4 border-l-red-600">
                    <label class="label-main text-red-400">20. í´ë¼ì´ë§¥ìŠ¤ & 21. ì„ íƒ</label>
                    <div class="space-y-4">
                        <textarea id="p_20" oninput="autoResize(this); saveData()" rows="3" class="input-dark" placeholder="ìµœí›„ì˜ ê²°ì „ (Climax)"></textarea>
                        <textarea id="p_21" oninput="autoResize(this); saveData()" rows="2" class="input-dark border-yellow-900/50" placeholder="ìµœí›„ì˜ ì„ íƒ (The Choice)"></textarea>
                    </div>
                </div>

                <div class="section-card border-l-4 border-l-emerald-500">
                    <label class="label-main text-emerald-400">22. í•´ì†Œ (Resolution)</label>
                    <textarea id="p_22" oninput="autoResize(this); saveData()" rows="3" class="input-dark" placeholder="ë³€í™”ëœ ì„¸ê³„ì™€ ì—¬ìš´"></textarea>
                </div>
            </div>
        </div>
    </main>

    <aside class="w-[450px] bg-gray-900 border-l border-gray-800 flex flex-col shadow-2xl z-20">
        <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-900 shrink-0">
            <h2 class="text-sm font-bold text-gray-100 uppercase tracking-widest flex items-center gap-2">
                ğŸ­ Character Deck
            </h2>
            <button onclick="addCharacter()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded font-bold transition shadow-lg">+ New Character</button>
        </div>
        
        <div id="character-list" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-900/50">
            </div>
    </aside>

    <script>
        // === ìë™ ë†’ì´ ì¡°ì ˆ ===
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        // === ë°ì´í„° êµ¬ì¡° ===
        let projectData = {
            concept: { logline: "", question: "", target: "", hook: "", theme: "", setting: "", rules: "", statusQuo: "" },
            characters: [], 
            plot: { p14: "", p15: "", p16: "", p17: "", p18: "", p19: "", p20: "", p21: "", p22: "" }
        };

        // === ì´ˆê¸°í™” ===
        window.onload = function() {
            const saved = localStorage.getItem('storyEngineV4');
            if (saved) {
                projectData = JSON.parse(saved);
                loadUI();
            } else {
                addCharacter();
            }
        };

        function saveData() {
            // Concept
            ['logline', 'question', 'target', 'hook', 'theme', 'setting', 'rules', 'statusQuo'].forEach(id => {
                const el = document.getElementById('f_' + id);
                if(el) projectData.concept[id] = el.value;
            });
            // Plot
            ['p14', 'p15', 'p16', 'p17', 'p18', 'p19', 'p20', 'p21', 'p22'].forEach(id => {
                const el = document.getElementById('p_' + id.replace('p', ''));
                if(el) projectData.plot[id.replace('_','')] = el.value;
            });

            localStorage.setItem('storyEngineV4', JSON.stringify(projectData));
            
            // ì €ì¥ ì•Œë¦¼
            const status = document.getElementById('save-status');
            status.style.opacity = '1';
            setTimeout(() => status.style.opacity = '0', 1000);
        }

        function loadUI() {
            // Textareas
            for (const [key, val] of Object.entries(projectData.concept)) {
                const el = document.getElementById('f_' + key);
                if(el) { el.value = val; autoResize(el); }
            }
            for (const [key, val] of Object.entries(projectData.plot)) {
                 const el = document.getElementById('p_' + key.replace('p',''));
                 if(el) { el.value = val; autoResize(el); }
            }
            // Characters
            const list = document.getElementById('character-list');
            list.innerHTML = '';
            projectData.characters.forEach(c => renderCharacterCard(c));
        }

        // === ìºë¦­í„° ê´€ë¦¬ (ìƒì„¸ í•­ëª© ëª¨ë‘ ë¶€í™œ) ===
        function addCharacter() {
            const newChar = {
                id: Date.now(),
                // Core
                name: "", role: "", color: "#3b82f6",
                // 1. Inner
                wound: "", want: "", need: "", flaw: "", values: "",
                // 2. Function
                position: "", secret: "", skill: "",
                // 3. Visual
                silhouette: "", item: "", habit: "", gap: "",
                // 4. Relations & Arc
                attitude: "", history: "",
                startState: "", catalyst: "", endState: "",
                isExpanded: true
            };
            projectData.characters.push(newChar);
            renderCharacterCard(newChar);
            saveData();
            setTimeout(() => {
                const list = document.getElementById('character-list');
                list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function renderCharacterCard(c) {
            const list = document.getElementById('character-list');
            const card = document.createElement('div');
            card.className = "bg-gray-800 rounded-lg border-l-4 shadow-lg overflow-hidden transition-all duration-200 group border-gray-700 mb-4";
            card.style.borderLeftColor = c.color;

            // ìƒì„¸ í•­ëª© HTML ìƒì„±
            card.innerHTML = `
                <div class="p-3 bg-gray-800 flex justify-between items-center cursor-pointer border-b border-gray-700 hover:bg-gray-750" onclick="toggleCard(${c.id})">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color:${c.color}"></div>
                        <div>
                            <h3 class="font-bold text-gray-200 text-sm truncate max-w-[200px]">${c.name || 'ìƒˆ ìºë¦­í„°'}</h3>
                            <p class="text-[10px] text-gray-500 truncate h-3">${c.role || 'ì—­í•  ë¯¸ì •'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <span class="text-[10px] text-gray-600 mr-1">${c.isExpanded ? 'â–²' : 'â–¼'}</span>
                        <button onclick="deleteChar(${c.id}, event)" class="text-gray-600 hover:text-red-400 px-1 text-lg">Ã—</button>
                    </div>
                </div>
                
                <div id="card-body-${c.id}" class="${c.isExpanded ? '' : 'hidden'} p-4 space-y-6 bg-gray-800/50 border-t border-gray-700">
                    
                    <div class="grid grid-cols-5 gap-2">
                        <div class="col-span-3">
                            <label class="label-char">ì´ë¦„ (Name)</label>
                            <input value="${c.name}" oninput="updateChar(${c.id}, 'name', this.value)" class="input-char font-bold text-base" placeholder="ì´ë¦„ ì…ë ¥">
                        </div>
                        <div class="col-span-2">
                             <label class="label-char">ìƒì§•ìƒ‰ (Color)</label>
                             <div class="h-[34px] bg-gray-900 rounded border border-gray-600 flex items-center px-1">
                                <input type="color" value="${c.color}" oninput="updateCharColor(${c.id}, this.value, this)" class="w-full h-6 bg-transparent cursor-pointer">
                             </div>
                        </div>
                    </div>
                    <div>
                        <label class="label-char">ì—­í•  (Role)</label>
                        <input value="${c.role}" oninput="updateChar(${c.id}, 'role', this.value)" class="input-char" placeholder="ì£¼ì¸ê³µ, ì¡°ë ¥ì, ë¹ŒëŸ°...">
                    </div>

                    <div class="pt-2 border-t border-gray-700/50">
                        <h4 class="text-xs font-bold text-blue-400 mb-2">ğŸ§  ë‚´ë©´ ì—”ì§„ (Inner)</h4>
                        <div class="space-y-3">
                            <div><label class="label-char text-gray-500">ìš•ë§ (Want)</label><textarea oninput="updateChar(${c.id}, 'want', this.value); autoResize(this)" rows="1" class="input-char" placeholder="ê²‰ìœ¼ë¡œ ì›í•˜ëŠ” ê²ƒ">${c.want}</textarea></div>
                            <div><label class="label-char text-gray-500">ê²°í•/í•„ìš” (Need)</label><textarea oninput="updateChar(${c.id}, 'need', this.value); autoResize(this)" rows="1" class="input-char" placeholder="ë‚´ë©´ì˜ êµ¬ë© / ì„±ì¥ì— í•„ìš”í•œ ê²ƒ">${c.need}</textarea></div>
                            <div><label class="label-char text-gray-500">ìƒì²˜ (Wound)</label><textarea oninput="updateChar(${c.id}, 'wound', this.value); autoResize(this)" rows="1" class="input-char" placeholder="ê³¼ê±°ì˜ íŠ¸ë¼ìš°ë§ˆ">${c.wound}</textarea></div>
                            <div><label class="label-char text-gray-500">ê²°í•¨ (Flaw)</label><textarea oninput="updateChar(${c.id}, 'flaw', this.value); autoResize(this)" rows="1" class="input-char" placeholder="ì¹˜ëª…ì  ì„±ê²© ê²°í•¨">${c.flaw}</textarea></div>
                        </div>
                    </div>

                    <div class="pt-2 border-t border-gray-700/50">
                         <h4 class="text-xs font-bold text-indigo-400 mb-2">ğŸ¤« ê¸°ëŠ¥ & ë¹„ë°€ (Secret)</h4>
                         <div class="space-y-3">
                            <div><label class="label-char text-gray-500">ë¹„ë°€ (Secret)</label><textarea oninput="updateChar(${c.id}, 'secret', this.value); autoResize(this)" rows="1" class="input-char" placeholder="ë‚¨ì—ê²Œ ë“¤í‚¤ë©´ ì•ˆ ë˜ëŠ” ê²ƒ">${c.secret}</textarea></div>
                            <div><label class="label-char text-gray-500">ì„œì‚¬ì  í¬ì§€ì…˜</label><input value="${c.position}" oninput="updateChar(${c.id}, 'position', this.value)" class="input-char" placeholder="ì˜ˆ: ì˜ì‹¬ ìœ ë°œì, ì •ë³´ ì „ë‹¬ì"></div>
                         </div>
                    </div>

                    <div class="pt-2 border-t border-gray-700/50">
                        <h4 class="text-xs font-bold text-emerald-400 mb-2">ğŸ‘ï¸ ë¹„ì£¼ì–¼ (Visual)</h4>
                        <div class="space-y-3">
                            <div><label class="label-char text-gray-500">ì™¸í˜•/ì‹¤ë£¨ì—£</label><textarea oninput="updateChar(${c.id}, 'silhouette', this.value); autoResize(this)" rows="1" class="input-char" placeholder="í‚¤, ì²´í˜•, ë¨¸ë¦¬ìŠ¤íƒ€ì¼">${c.silhouette}</textarea></div>
                            <div><label class="label-char text-gray-500">ì•„ì´í…œ/ë²„ë¦‡</label><textarea oninput="updateChar(${c.id}, 'item', this.value); autoResize(this)" rows="1" class="input-char" placeholder="ì‹œê·¸ë‹ˆì²˜ ì•„ì´í…œ or ìŠµê´€">${c.item}</textarea></div>
                            <div><label class="label-char text-gray-500">ë°˜ì „ ë§¤ë ¥ (Gap)</label><input value="${c.gap}" oninput="updateChar(${c.id}, 'gap', this.value)" class="input-char" placeholder="ì²«ì¸ìƒ vs ì‹¤ì œ"></div>
                        </div>
                    </div>

                     <div class="pt-2 border-t border-gray-700/50">
                        <h4 class="text-xs font-bold text-orange-400 mb-2">ğŸ“ˆ ì„±ì¥ ì•„í¬ (Arc)</h4>
                        <div class="space-y-3">
                            <div><label class="label-char text-gray-500">ì‹œì‘ì  -> ë„ì°©ì </label>
                            <div class="flex gap-2">
                                <input value="${c.startState}" oninput="updateChar(${c.id}, 'startState', this.value)" class="input-char" placeholder="ì‹œì‘">
                                <span class="text-gray-500 pt-1">-></span>
                                <input value="${c.endState}" oninput="updateChar(${c.id}, 'endState', this.value)" class="input-char" placeholder="ë">
                            </div>
                            </div>
                        </div>
                    </div>

                </div>
            `;
            list.appendChild(card);
            // í…ìŠ¤íŠ¸ì˜ì—­ ë†’ì´ ìë™ ì¡°ì ˆ
            card.querySelectorAll('textarea').forEach(el => autoResize(el));
        }

        function toggleCard(id) {
            const body = document.getElementById(`card-body-${id}`);
            const char = projectData.characters.find(c => c.id === id);
            body.classList.toggle('hidden');
            
            // í† ê¸€ ì•„ì´ì½˜ ë³€ê²½ (ê°„ë‹¨ êµ¬í˜„)
            const icon = body.previousElementSibling.querySelector('span');
            if(icon) icon.textContent = body.classList.contains('hidden') ? 'â–¼' : 'â–²';

            if(char) char.isExpanded = !body.classList.contains('hidden');
            saveData();
        }

        function updateChar(id, key, val) {
            const idx = projectData.characters.findIndex(c => c.id === id);
            if(idx > -1) {
                projectData.characters[idx][key] = val;
                saveData();
                // ì´ë¦„/ì—­í•  ì‹¤ì‹œê°„ í—¤ë” ë°˜ì˜ (ì„ íƒì‚¬í•­)
                if(key === 'name' || key === 'role') {
                    const cardBody = document.getElementById(`card-body-${id}`);
                    const header = cardBody.previousElementSibling;
                    if(key === 'name') header.querySelector('h3').textContent = val || 'ìƒˆ ìºë¦­í„°';
                    if(key === 'role') header.querySelector('p').textContent = val || 'ì—­í•  ë¯¸ì •';
                }
            }
        }

        function updateCharColor(id, color, inputEl) {
            const idx = projectData.characters.findIndex(c => c.id === id);
            if(idx > -1) {
                projectData.characters[idx].color = color;
                const card = inputEl.closest('.group');
                card.style.borderLeftColor = color;
                card.querySelector('.rounded-full').style.backgroundColor = color;
                saveData();
            }
        }

        function deleteChar(id, e) {
            e.stopPropagation();
            if(confirm('ì´ ìºë¦­í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                projectData.characters = projectData.characters.filter(c => c.id !== id);
                saveData();
                loadUI();
            }
        }

        function exportData() {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData, null, 2));
            const node = document.createElement('a');
            node.href = str;
            node.download = "story_engine_v4_ultimate.json";
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        function clearData() {
            if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('storyEngineV4');
                location.reload();
            }
        }
    </script>
</body>
</html>
        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼: ë°°ê²½ê³¼ ì¡°í™”, ìë™ ë†’ì´ ì¡°ì ˆì„ ìœ„í•´ transition ì œê±° */
        .input-dark { 
            @apply w-full bg-gray-800 text-gray-200 border border-gray-700 rounded-lg px-4 py-3 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none placeholder-gray-600 resize-none overflow-hidden leading-relaxed; 
        }

        /* ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .label-main { @apply block text-xs font-bold uppercase tracking-wider text-gray-500 mb-2; }
        
        /* ì„¹ì…˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ê³µí†µ) */
        .section-card { @apply bg-gray-900/50 rounded-xl p-6 border border-gray-800 hover:border-gray-700 transition-colors duration-300; }
        
        /* Part í—¤ë” ìŠ¤íƒ€ì¼ */
        .part-header { @apply flex items-center gap-3 text-xl font-bold text-gray-200 mb-6 pb-4 border-b border-gray-800; }
        .part-badge { @apply text-xs px-2 py-1 rounded font-bold tracking-wide; }

    </style>
</head>
<body class="bg-slate-950 text-slate-300 font-sans h-screen flex overflow-hidden selection:bg-blue-500/30">

    <main class="flex-1 overflow-y-auto relative p-8 md:p-12 scroll-smooth" id="main-scroll">
        
        <div class="flex justify-between items-end mb-16">
            <div>
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 tracking-tight">Story Engine v3.5</h1>
                <p class="text-sm text-gray-500 mt-2">Refined Dark Dashboard</p>
            </div>
            <div class="flex gap-2">
                <button onclick="exportData()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg border border-slate-700 transition">ğŸ“¥ JSON ì €ì¥</button>
                <button onclick="clearData()" class="text-xs bg-transparent hover:text-red-400 text-slate-600 px-4 py-2 rounded transition">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div id="save-status" class="fixed top-6 left-1/2 transform -translate-x-1/2 text-xs text-emerald-500 font-mono opacity-0 transition-opacity pointer-events-none bg-slate-900 px-3 py-1 rounded-full border border-emerald-900/50 shadow-lg">
            â— Auto-saved
        </div>

        <div class="mb-12">
            <div class="part-header">
                <span class="part-badge bg-blue-900/30 text-blue-400">PART 1</span> 
                ì»¨ì…‰ & êµ¬ì¡° (Concept)
            </div>
            
            <div class="space-y-6">
                <div class="section-card border-l-4 border-l-blue-500">
                    <label class="label-main text-blue-400">1. ì•„ì´ëŸ¬ë‹ˆ ë¡œê·¸ë¼ì¸ (The Hook)</label>
                    <textarea id="f_logline" oninput="autoResize(this); saveData()" rows="1" class="input-dark text-lg font-medium" placeholder="ì£¼ì¸ê³µì˜ íŠ¹ì„±ê³¼ ìƒí™©ì´ ëª¨ìˆœë˜ëŠ” ê²°ì •ì  í•œ ë¬¸ì¥"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="section-card">
                        <label class="label-main">2. í•µì‹¬ ì§ˆë¬¸ (Dramatic Question)</label>
                        <textarea id="f_question" oninput="autoResize(this); saveData()" rows="1" class="input-dark" placeholder="ë…ìê°€ ëê¹Œì§€ ê¶ê¸ˆí•´í•  ì§ˆë¬¸"></textarea>
                    </div>
                    <div class="section-card border border-blue-500/30 bg-blue-900/10">
                        <label class="label-main text-blue-300">23. í…Œë§ˆ (Theme)</label>
                        <textarea id="f_theme" oninput="autoResize(this); saveData()" rows="1" class="input-dark bg-blue-900/20 border-blue-500/30 focus:border-blue-400" placeholder="ê²°êµ­ ì´ ì´ì•¼ê¸°ëŠ” ë¬´ì—‡ì— ê´€í•œ ê²ƒì¸ê°€?"></textarea>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="section-card">
                        <label class="label-main">3. íƒ€ê²Ÿ & ì¥ë¥´</label>
                        <textarea id="f_target" oninput="autoResize(this); saveData()" rows="1" class="input-dark"></textarea>
                    </div>
                    <div class="section-card">
                        <label class="label-main">4. ì°¨ë³„í™” í¬ì¸íŠ¸</label>
                        <textarea id="f_hook" oninput="autoResize(this); saveData()" rows="1" class="input-dark"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-12">
            <div class="part-header">
                <span class="part-badge bg-indigo-900/30 text-indigo-400">PART 2</span> 
                ì„¸ê³„ê´€ (World)
            </div>
            <div class="grid grid-cols-1 gap-6">
                <div class="section-card">
                    <label class="label-main">11. ë°°ê²½ (Setting)</label>
                    <textarea id="f_setting" oninput="autoResize(this); saveData()" rows="1" class="input-dark" placeholder="ì‹œê°„ì , ê³µê°„ì  ë°°ê²½ê³¼ ë¶„ìœ„ê¸°"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="section-card">
                        <label class="label-main">12. ê·œì¹™ (Rules)</label>
                        <textarea id="f_rules" oninput="autoResize(this); saveData()" rows="2" class="input-dark" placeholder="ì´ ì„¸ê³„ì˜ ì œì•½ì´ë‚˜ ë²•ì¹™"></textarea>
                    </div>
                    <div class="section-card">
                        <label class="label-main">13. ì¼ìƒì˜ ë¶•ê´´ ì „</label>
                        <textarea id="f_statusQuo" oninput="autoResize(this); saveData()" rows="2" class="input-dark" placeholder="ì‚¬ê±´ ë°œìƒ ì „ í‰ë²”í•œ ì¼ìƒ"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="pb-24">
            <div class="part-header">
                <span class="part-badge bg-purple-900/30 text-purple-400">PART 3</span> 
                í”Œë¡¯ì˜ íŒŒë™ (The Plot)
            </div>

            <div class="space-y-8 relative">
                <div class="absolute left-6 top-6 bottom-6 w-0.5 bg-gradient-to-b from-blue-500 via-purple-500 to-emerald-500 opacity-20 hidden md:block"></div>

                <div class="section-card border-l-4 border-l-sky-500 ml-0 md:ml-10 relative">
                    <div class="absolute -left-[45px] top-6 w-3 h-3 rounded-full bg-sky-500 hidden md:block"></div>
                    <h3 class="text-sky-400 font-bold text-lg mb-1">14. ë„ì…ë¶€ ì‚¬ê±´ (Inciting Incident)</h3>
                    <p class="text-xs text-slate-500 mb-3">ì¼ìƒì— ë¶ˆì„ ì§€ë¥´ëŠ” ì‚¬ê±´</p>
                    <textarea id="p_14" oninput="autoResize(this); saveData()" rows="2" class="input-dark"></textarea>
                </div>

                <div class="section-card border-l-4 border-l-blue-500 ml-0 md:ml-10 relative">
                    <div class="absolute -left-[45px] top-6 w-3 h-3 rounded-full bg-blue-500 hidden md:block"></div>
                    <h3 class="text-blue-400 font-bold text-lg mb-1">15. íšŒê·€ ë¶ˆê°€ ì§€ì  (Point of No Return)</h3>
                    <p class="text-xs text-slate-500 mb-3">ìƒˆë¡œìš´ ì„¸ê³„ë¡œì˜ ì§„ì…</p>
                    <textarea id="p_15" oninput="autoResize(this); saveData()" rows="2" class="input-dark"></textarea>
                </div>

                <div class="section-card border-l-4 border-l-indigo-500 ml-0 md:ml-10 relative">
                    <div class="absolute -left-[45px] top-6 w-3 h-3 rounded-full bg-indigo-500 hidden md:block"></div>
                    <h3 class="text-indigo-400 font-bold text-lg mb-1">16. ì‹œë ¨ê³¼ ìƒìŠ¹ (Rising Action)</h3>
                    <p class="text-xs text-slate-500 mb-3">ì ì  ì»¤ì§€ëŠ” ì¥ì• ë¬¼ë“¤</p>
                    <textarea id="p_16" oninput="autoResize(this); saveData()" rows="3" class="input-dark"></textarea>
                </div>

                <div class="section-card border-l-4 border-l-purple-500 ml-0 md:ml-10 relative bg-purple-900/10 border-purple-500/50">
                    <div class="absolute -left-[45px] top-6 w-4 h-4 rounded-full bg-purple-500 shadow-[0_0_10px_rgba(168,85,247,0.5)] hidden md:block"></div>
                    <h3 class="text-purple-400 font-black text-xl mb-1">17. ë¯¸ë“œí¬ì¸íŠ¸ (Mid-point)</h3>
                    <p class="text-xs text-purple-300/70 mb-3">íŒì´ ë’¤ì§‘íˆëŠ” ê±°ëŒ€í•œ ë°˜ì „. ì£¼ì¸ê³µì˜ ê°ì„±.</p>
                    <textarea id="p_17" oninput="autoResize(this); saveData()" rows="3" class="input-dark bg-purple-900/20 border-purple-500/30"></textarea>
                </div>

                <div class="section-card border-l-4 border-l-orange-500 ml-0 md:ml-10 relative">
                    <div class="absolute -left-[45px] top-6 w-3 h-3 rounded-full bg-orange-500 hidden md:block"></div>
                    <h3 class="text-orange-400 font-bold text-lg mb-1">18. íŒëˆ ìƒìŠ¹ & 19. íŒ¨ë°°</h3>
                    <p class="text-xs text-slate-500 mb-3">ì‹¤íŒ¨ ì‹œ ìƒëŠ” ê²ƒ & ìµœì•…ì˜ ì ˆë§</p>
                    <div class="space-y-3">
                        <textarea id="p_18" oninput="autoResize(this); saveData()" rows="1" class="input-dark" placeholder="íŒëˆ ìƒìŠ¹ (Stakes)"></textarea>
                        <textarea id="p_19" oninput="autoResize(this); saveData()" rows="1" class="input-dark" placeholder="ëª¨ë“  ê²ƒì„ ìƒì€ ìˆœê°„ (All is Lost)"></textarea>
                    </div>
                </div>

                <div class="section-card border-l-4 border-l-red-500 ml-0 md:ml-10 relative">
                    <div class="absolute -left-[45px] top-6 w-3 h-3 rounded-full bg-red-500 hidden md:block"></div>
                    <h3 class="text-red-400 font-bold text-lg mb-1">20. í´ë¼ì´ë§¥ìŠ¤ & 21. ì„ íƒ</h3>
                    <p class="text-xs text-slate-500 mb-3">ìµœí›„ì˜ ê²°ì „ê³¼ í¬ìƒ</p>
                     <div class="space-y-3">
                        <textarea id="p_20" oninput="autoResize(this); saveData()" rows="2" class="input-dark" placeholder="í´ë¼ì´ë§¥ìŠ¤ (Climax)"></textarea>
                        <textarea id="p_21" oninput="autoResize(this); saveData()" rows="1" class="input-dark" placeholder="ìµœí›„ì˜ ì„ íƒ (The Choice)"></textarea>
                    </div>
                </div>

                <div class="section-card border-l-4 border-l-emerald-500 ml-0 md:ml-10 relative">
                    <div class="absolute -left-[45px] top-6 w-3 h-3 rounded-full bg-emerald-500 hidden md:block"></div>
                    <h3 class="text-emerald-400 font-bold text-lg mb-1">22. í•´ì†Œ (Resolution)</h3>
                    <p class="text-xs text-slate-500 mb-3">ë³€í™”ëœ ì„¸ê³„ì™€ ì—¬ìš´</p>
                    <textarea id="p_22" oninput="autoResize(this); saveData()" rows="2" class="input-dark"></textarea>
                </div>
            </div>
        </div>
    </main>

    <aside class="w-[380px] bg-slate-900 border-l border-slate-800 flex flex-col shadow-2xl z-10">
        <div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900">
            <h2 class="text-sm font-bold text-slate-300 uppercase tracking-wider">ğŸ­ Character Deck</h2>
            <button onclick="addCharacter()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded font-bold shadow transition">+ New</button>
        </div>
        
        <div id="character-list" class="flex-1 overflow-y-auto p-4 space-y-4">
            </div>
    </aside>

    <script>
        // === Auto Resize Function (í•µì‹¬ ê¸°ëŠ¥) ===
        function autoResize(el) {
            el.style.height = 'auto'; // ë†’ì´ ì´ˆê¸°í™”
            el.style.height = el.scrollHeight + 'px'; // ë‚´ìš©ë§Œí¼ ëŠ˜ë¦¬ê¸°
        }

        // === ë°ì´í„° êµ¬ì¡° ===
        let projectData = {
            concept: { logline: "", question: "", target: "", hook: "", theme: "", setting: "", rules: "", statusQuo: "" },
            characters: [], 
            plot: { p14: "", p15: "", p16: "", p17: "", p18: "", p19: "", p20: "", p21: "", p22: "" }
        };

        // ì´ˆê¸°í™”
        window.onload = function() {
            const saved = localStorage.getItem('storyDashboardV35');
            if (saved) {
                projectData = JSON.parse(saved);
                loadUI();
            } else {
                addCharacter();
            }
        };

        function saveData() {
            // Concept
            ['logline', 'question', 'target', 'hook', 'theme', 'setting', 'rules', 'statusQuo'].forEach(id => {
                const el = document.getElementById('f_' + id);
                if(el) projectData.concept[id] = el.value;
            });
            // Plot
            ['p14', 'p15', 'p16', 'p17', 'p18', 'p19', 'p20', 'p21', 'p22'].forEach(id => {
                const el = document.getElementById('p_' + id.replace('p', ''));
                if(el) projectData.plot[id.replace('_','')] = el.value;
            });

            localStorage.setItem('storyDashboardV35', JSON.stringify(projectData));
            
            const status = document.getElementById('save-status');
            status.style.opacity = '1';
            setTimeout(() => status.style.opacity = '0', 1000);
        }

        function loadUI() {
            // ë°ì´í„° ë¡œë“œ í›„ ë†’ì´ ìë™ ì¡°ì ˆê¹Œì§€ ì‹¤í–‰
            for (const [key, val] of Object.entries(projectData.concept)) {
                const el = document.getElementById('f_' + key);
                if(el) { el.value = val; autoResize(el); }
            }
            for (const [key, val] of Object.entries(projectData.plot)) {
                 const el = document.getElementById('p_' + key.replace('p',''));
                 if(el) { el.value = val; autoResize(el); }
            }
            const list = document.getElementById('character-list');
            list.innerHTML = '';
            projectData.characters.forEach(c => renderCharacterCard(c));
        }

        // === ìºë¦­í„° ê´€ë¦¬ (ë””ìì¸ ê°œì„ ) ===
        function addCharacter() {
            const newChar = {
                id: Date.now(),
                name: "", role: "", color: "#3b82f6",
                wound: "", want: "", need: "", flaw: "",
                secret: "", attitude: "",
                silhouette: "", item: "",
                startState: "", endState: "",
                isExpanded: true
            };
            projectData.characters.push(newChar);
            renderCharacterCard(newChar);
            saveData();
            setTimeout(() => {
                const list = document.getElementById('character-list');
                list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function renderCharacterCard(c) {
            const list = document.getElementById('character-list');
            const card = document.createElement('div');
            card.className = "bg-slate-800 rounded-lg border-l-[6px] shadow-lg overflow-hidden transition-all duration-200 group border-gray-700";
            card.style.borderLeftColor = c.color;

            card.innerHTML = `
                <div class="p-3 bg-slate-800 flex justify-between items-center cursor-pointer border-b border-slate-700 hover:bg-slate-750" onclick="toggleCard(${c.id})">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color:${c.color}"></div>
                        <div>
                            <h3 class="font-bold text-gray-200 text-sm truncate max-w-[120px]">${c.name || 'New Character'}</h3>
                            <p class="text-[10px] text-gray-500 truncate h-3">${c.role || ''}</p>
                        </div>
                    </div>
                    <button onclick="deleteChar(${c.id}, event)" class="text-gray-600 hover:text-red-400 px-2">Ã—</button>
                </div>
                
                <div id="card-body-${c.id}" class="${c.isExpanded ? '' : 'hidden'} p-3 space-y-4 bg-slate-800/50">
                    <div class="grid grid-cols-5 gap-2">
                        <div class="col-span-3">
                            <label class="label-main text-[10px]">Name</label>
                            <textarea oninput="updateChar(${c.id}, 'name', this.value); autoResize(this)" rows="1" class="input-dark font-bold text-white bg-slate-900">${c.name}</textarea>
                        </div>
                        <div class="col-span-2">
                             <label class="label-main text-[10px]">Color</label>
                             <div class="h-[42px] bg-slate-900 rounded-lg border border-slate-700 flex items-center justify-center px-1">
                                <input type="color" value="${c.color}" oninput="updateCharColor(${c.id}, this.value, this)" class="w-full h-8 bg-transparent cursor-pointer rounded">
                             </div>
                        </div>
                    </div>
                    <div>
                        <label class="label-main text-[10px]">Role</label>
                        <textarea oninput="updateChar(${c.id}, 'role', this.value); autoResize(this)" rows="1" class="input-dark" placeholder="ì£¼ì¸ê³µ, ì¡°ë ¥ì...">${c.role}</textarea>
                    </div>
                    
                    <div class="space-y-2 pt-2 border-t border-slate-700/50">
                        <label class="label-main text-[10px] text-blue-400">Inner Engine</label>
                        <textarea oninput="updateChar(${c.id}, 'want', this.value); autoResize(this)" rows="1" class="input-dark" placeholder="ìš•ë§ (Want)">${c.want}</textarea>
                        <textarea oninput="updateChar(${c.id}, 'flaw', this.value); autoResize(this)" rows="1" class="input-dark" placeholder="ê²°í•¨ (Flaw)">${c.flaw}</textarea>
                    </div>

                    <div class="space-y-2 pt-2 border-t border-slate-700/50">
                         <label class="label-main text-[10px] text-emerald-400">Visual</label>
                        <textarea oninput="updateChar(${c.id}, 'silhouette', this.value); autoResize(this)" rows="1" class="input-dark" placeholder="ì™¸í˜•/íŠ¹ì§•">${c.silhouette}</textarea>
                    </div>
                </div>
            `;
            list.appendChild(card);
            // ë Œë”ë§ í›„ í…ìŠ¤íŠ¸ì˜ì—­ ë¦¬ì‚¬ì´ì¦ˆ
            card.querySelectorAll('textarea').forEach(el => autoResize(el));
        }

        function toggleCard(id) {
            const body = document.getElementById(`card-body-${id}`);
            const char = projectData.characters.find(c => c.id === id);
            body.classList.toggle('hidden');
            if(char) char.isExpanded = !body.classList.contains('hidden');
            saveData();
        }

        function updateChar(id, key, val) {
            const idx = projectData.characters.findIndex(c => c.id === id);
            if(idx > -1) {
                projectData.characters[idx][key] = val;
                saveData();
            }
        }

        function updateCharColor(id, color, inputEl) {
            const idx = projectData.characters.findIndex(c => c.id === id);
            if(idx > -1) {
                projectData.characters[idx].color = color;
                inputEl.closest('.group').style.borderLeftColor = color;
                inputEl.closest('.group').querySelector('.rounded-full').style.backgroundColor = color;
                saveData();
            }
        }

        function deleteChar(id, e) {
            e.stopPropagation();
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                projectData.characters = projectData.characters.filter(c => c.id !== id);
                saveData();
                loadUI();
            }
        }
        function exportData() {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData, null, 2));
            const node = document.createElement('a');
            node.href = str;
            node.download = "story_engine_v3_5.json";
            document.body.appendChild(node);
            node.click();
            node.remove();
        }
        function clearData() {
            if(confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('storyDashboardV35');
                location.reload();
            }
        }
    </script>
</body>
</html>
