<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Zettelkasten Indexer - Custom Filename</title>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #f4f7f6; --link: #3498db; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 20px; color: var(--primary); }
        .container { max-width: 900px; margin: 0 auto; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; }
        .search-box { flex: 1; padding: 12px; border: 2px solid var(--primary); border-radius: 8px; font-size: 1rem; }
        .btn-util { padding: 8px 15px; border-radius: 6px; cursor: pointer; border: 1px solid #ccc; background: white; font-size: 0.85rem; font-weight: bold; }
        .btn-util:hover { background: #eee; }

        .tag-index { background: white; padding: 15px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .index-item { display: inline-block; padding: 4px 12px; background: #e8ecef; margin: 3px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; text-decoration: none; color: inherit; }

        .card-panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .input-grid { display: grid; grid-template-columns: 150px 250px 1fr auto; gap: 10px; }
        textarea { grid-column: span 3; height: 60px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; resize: none; }
        .add-btn { background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; padding: 0 20px; }

        .random-box { background: #2c3e50; color: white; text-align: center; padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        .random-btn { background: var(--accent); color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; margin-bottom: 15px; }
        .random-display { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .r-card { background: white; color: #333; width: 140px; padding: 15px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; }

        .category-group { margin-bottom: 40px; scroll-margin-top: 20px; }
        .category-header { border-bottom: 2px solid var(--primary); padding-bottom: 5px; margin-bottom: 15px; }
        .z-card { background: white; border: 1px solid #e1e4e8; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: flex-start; gap: 15px; }
        .num-tag { background: #edf2f7; color: var(--primary); padding: 5px 10px; border-radius: 6px; font-weight: bold; min-width: 80px; text-align: center; }
        .content { flex: 1; }
        .actions { display: flex; gap: 5px; }
        .btn-sm { font-size: 0.75rem; padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; background: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <input type="text" id="searchBar" class="search-box" placeholder="ê²€ìƒ‰ (ë²ˆí˜¸, ë‚´ìš©, íƒœê·¸...)" oninput="renderList()">
        <button class="btn-util" onclick="exportToFile()">ğŸ“‚ ì´ë¦„ ì§€ì •í•˜ì—¬ ë°±ì—…</button>
        <button class="btn-util" onclick="importFromFile()">ğŸ“¥ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <div class="tag-index">
        <h4>ğŸ”– íƒœê·¸ ìƒ‰ì¸ (í´ë¦­ ì‹œ ì´ë™)</h4>
        <div id="indexContainer"></div>
    </div>

    <div class="random-box">
        <button class="random-btn" onclick="drawCards()">ğŸ² ë¬´ì‘ìœ„ ì¹´ë“œ 3~5ì¥ ì¶”ì¶œ</button>
        <div id="randomDisplay" class="random-display"></div>
    </div>

    <div class="card-panel">
        <div class="input-grid">
            <input type="text" id="cardNumber" placeholder="ë²ˆí˜¸ (í•„ìˆ˜)">
            <input type="text" id="tags" placeholder="íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)">
            <button class="add-btn" onclick="addCard()">ë“±ë¡</button>
            <textarea id="summary" placeholder="ìš”ì•½ ë‚´ìš©... [[ë²ˆí˜¸]]ë¥¼ ì“°ë©´ ë§í¬ê°€ ê°•ì¡°ë©ë‹ˆë‹¤."></textarea>
        </div>
    </div>

    <div id="categoryList"></div>
</div>

<script>
    let cards = JSON.parse(localStorage.getItem('zettel_v_final')) || [];

    function addCard() {
        const num = document.getElementById('cardNumber').value.trim();
        const tagInput = document.getElementById('tags').value.trim();
        const summary = document.getElementById('summary').value.trim();
        if(!num) return alert("ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        cards.push({ id: Date.now(), num, tags: tagInput ? tagInput.split(',').map(t => t.trim()) : ['ë¯¸ë¶„ë¥˜'], summary });
        saveAndRender();
        document.getElementById('cardNumber').value = '';
        document.getElementById('tags').value = '';
        document.getElementById('summary').value = '';
    }

    function saveAndRender() {
        localStorage.setItem('zettel_v_final', JSON.stringify(cards));
        renderList();
    }

    // [ê°œì„ ëœ ì €ì¥ ê¸°ëŠ¥] íŒŒì¼ ì´ë¦„ ìˆ˜ì • í”„ë¡œì„¸ìŠ¤
    async function exportToFile() {
        if (!window.showSaveFilePicker) return alert("ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
        
        const today = new Date().toISOString().slice(0,10).replace(/-/g, '');
        // ê¸°ë³¸ íŒŒì¼ëª… ì œì•ˆ (ë‚ ì§œ_ì¹´ë“œê°œìˆ˜)
        const defaultName = `zettel_${today}_${cards.length}cards.json`;
        
        // ë¸Œë¼ìš°ì € í”„ë¡¬í”„íŠ¸ë¡œ íŒŒì¼ëª… ìˆ˜ì • ê¸°íšŒ ì œê³µ
        const customName = prompt("ì €ì¥í•  íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", defaultName);
        if (!customName) return; // ì·¨ì†Œ ì‹œ ì¤‘ë‹¨

        try {
            const handle = await window.showSaveFilePicker({
                suggestedName: customName.endsWith('.json') ? customName : customName + '.json',
                types: [{ description: 'JSON File', accept: {'application/json': ['.json']} }]
            });
            const writable = await handle.createWritable();
            await writable.write(JSON.stringify(cards, null, 2));
            await writable.close();
            alert("ë°±ì—… ì™„ë£Œ!");
        } catch (err) { console.error(err); }
    }

    async function importFromFile() {
        try {
            const [handle] = await window.showOpenFilePicker();
            const file = await handle.getFile();
            cards = JSON.parse(await file.text());
            saveAndRender();
        } catch (err) { console.error(err); }
    }

    function renderList() {
        const searchTerm = document.getElementById('searchBar').value.toLowerCase();
        const listDiv = document.getElementById('categoryList');
        const indexDiv = document.getElementById('indexContainer');
        listDiv.innerHTML = ''; indexDiv.innerHTML = '';

        const tagGroups = {};
        cards.forEach(card => {
            if(card.num.toLowerCase().includes(searchTerm) || card.summary.toLowerCase().includes(searchTerm)) {
                card.tags.forEach(tag => {
                    (tagGroups[tag] = tagGroups[tag] || []).push(card);
                });
            }
        });

        Object.keys(tagGroups).sort().forEach(tag => {
            const a = document.createElement('a');
            a.className = 'index-item';
            a.innerText = `${tag} (${tagGroups[tag].length})`;
            a.href = `#tag-${tag}`;
            indexDiv.appendChild(a);

            let section = `<div class="category-group" id="tag-${tag}"><div class="category-header"><h3># ${tag}</h3></div>`;
            tagGroups[tag].forEach(card => {
                section += `
                    <div class="z-card">
                        <div class="num-tag">${card.num}</div>
                        <div class="content"><div>${card.summary.replace(/\[\[(.*?)\]\]/g, '<b style="color:var(--link)">[[ $1 ]]</b>')}</div></div>
                        <div class="actions">
                            <button class="btn-sm" onclick="editCard(${card.id})">ìˆ˜ì •</button>
                            <button class="btn-sm" onclick="deleteCard(${card.id})">ì‚­ì œ</button>
                        </div>
                    </div>`;
            });
            listDiv.innerHTML += section + `</div>`;
        });
    }

    function editCard(id) {
        const card = cards.find(c => c.id === id);
        const n = prompt("ë²ˆí˜¸:", card.num); if(!n) return;
        card.num = n;
        card.tags = prompt("íƒœê·¸:", card.tags.join(', ')).split(',').map(t => t.trim());
        card.summary = prompt("ë‚´ìš©:", card.summary);
        saveAndRender();
    }

    function deleteCard(id) { if(confirm("ì‚­ì œ?")) { cards = cards.filter(c => c.id !== id); saveAndRender(); } }
    
    function drawCards() {
        const display = document.getElementById('randomDisplay');
        display.innerHTML = '';
        [...cards].sort(() => 0.5 - Math.random()).slice(0, Math.floor(Math.random()*3)+3).forEach(c => {
            display.innerHTML += `<div class="r-card"><b>${c.num}</b><br><small>${c.summary.slice(0,20)}...</small></div>`;
        });
    }

    renderList();
</script>
</body>
</html>
