<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zettelkasten Pro - iPad Optimized</title>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #f4f7f6; --link: #3498db; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); padding: 15px; color: var(--primary); -webkit-tap-highlight-color: transparent; line-height: 1.5; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* ìƒë‹¨ ë°” ë° ê²€ìƒ‰ */
        .top-bar { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        .search-box { flex: 1; min-width: 200px; padding: 12px; border: 2px solid var(--primary); border-radius: 8px; font-size: 1rem; }
        .btn-util { padding: 10px 15px; border-radius: 6px; cursor: pointer; border: 1px solid #ccc; background: white; font-size: 0.85rem; font-weight: bold; }

        /* íƒœê·¸ ìƒ‰ì¸ */
        .tag-index { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tag-index h4 { margin: 0 0 10px 0; font-size: 0.9rem; color: #666; }
        .index-item { display: inline-block; padding: 6px 14px; background: #e8ecef; margin: 4px; border-radius: 20px; font-size: 0.9rem; text-decoration: none; color: inherit; }

        /* ì…ë ¥ ì„¹ì…˜ */
        .card-panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-grid input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        textarea { grid-column: span 2; height: 100px; padding: 12px; border-radius: 8px; border: 1px solid #ddd; resize: none; font-size: 1rem; }
        .add-btn { grid-column: span 2; background: var(--primary); color: white; border: none; border-radius: 8px; padding: 15px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }

        /* ëœë¤ ë¯¹ìŠ¤ */
        .random-box { background: #2c3e50; color: white; text-align: center; padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        .random-btn { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .random-display { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-top: 20px; }
        .r-card { background: white; color: #333; width: 130px; padding: 15px; border-radius: 10px; text-align: center; font-size: 0.85rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
        .category-group { margin-bottom: 35px; scroll-margin-top: 20px; }
        .category-group h3 { border-bottom: 2px solid var(--primary); padding-bottom: 5px; margin-bottom: 15px; }
        .z-card { background: white; border: 1px solid #e1e4e8; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: block; }
        .num-tag { color: var(--accent); font-weight: 900; font-size: 1.1rem; margin-bottom: 8px; display: block; }
        .wiki-link { color: var(--link); font-weight: bold; }
        .actions { margin-top: 12px; display: flex; gap: 10px; }
        .btn-sm { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 0.85rem; }
        .btn-del { color: #e74c3c; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <input type="text" id="searchBar" class="search-box" placeholder="ê²€ìƒ‰ (ë²ˆí˜¸, ë‚´ìš©, íƒœê·¸...)" oninput="renderList()">
        <button class="btn-util" onclick="exportData()">ğŸ“¤ í´ë” ì§€ì • ë°±ì—…</button>
        <button class="btn-util" onclick="document.getElementById('fileInput').click()">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(event)" accept=".json">
    </div>

    <div class="tag-index">
        <h4>ğŸ”– íƒœê·¸ ìƒ‰ì¸ (í´ë¦­ ì‹œ ì´ë™)</h4>
        <div id="indexContainer"></div>
    </div>

    <div class="random-box">
        <button class="random-btn" onclick="drawCards()">ğŸ² ë¬´ì‘ìœ„ ì¹´ë“œ ì¶”ì¶œ</button>
        <div id="randomDisplay" class="random-display"></div>
    </div>

    <div class="card-panel">
        <div class="input-grid">
            <input type="text" id="cardNumber" placeholder="ì¹´ë“œ ë²ˆí˜¸">
            <input type="text" id="tags" placeholder="íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)">
            <textarea id="summary" placeholder="ìš”ì•½ ë‚´ìš©... [[ë²ˆí˜¸]] ì…ë ¥ ì‹œ ê°•ì¡°"></textarea>
            <button class="add-btn" onclick="addCard()">ì¹´ë“œ ë“±ë¡</button>
        </div>
    </div>

    <div id="categoryList"></div>
</div>

<script>
    let cards = JSON.parse(localStorage.getItem('zettel_v_ipad_final')) || [];

    function addCard() {
        const num = document.getElementById('cardNumber').value.trim();
        const tagInput = document.getElementById('tags').value.trim();
        const summary = document.getElementById('summary').value.trim();
        if(!num) return alert("ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        
        cards.push({ id: Date.now(), num, tags: tagInput ? tagInput.split(',').map(t => t.trim()) : ['ë¯¸ë¶„ë¥˜'], summary });
        saveAndRender();
        document.getElementById('cardNumber').value = '';
        document.getElementById('tags').value = '';
        document.getElementById('summary').value = '';
    }

    function saveAndRender() {
        localStorage.setItem('zettel_v_ipad_final', JSON.stringify(cards));
        renderList();
    }

    // [ì•„ì´íŒ¨ë“œ í´ë” ì§€ì • ê°€ëŠ¥ ë°±ì—… ê¸°ëŠ¥]
    async function exportData() {
        if (cards.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        
        const today = new Date().toISOString().slice(0,10).replace(/-/g, '');
        const defaultName = `zettel_${today}.json`;
        const fileName = prompt("ì €ì¥í•  íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", defaultName);
        if (!fileName) return;

        const finalFileName = fileName.endsWith('.json') ? fileName : fileName + '.json';
        const dataStr = JSON.stringify(cards, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });

        // Web Share APIë¥¼ ì´ìš©í•œ í´ë” ì§€ì • ì €ì¥ ë°©ì‹ (ì•„ì´íŒ¨ë“œ ìµœì í™”)
        if (navigator.canShare && navigator.share) {
            try {
                const file = new File([blob], finalFileName, { type: "application/json" });
                await navigator.share({
                    files: [file],
                    title: 'ì œí…”ì¹´ìŠ¤í… ë°±ì—…',
                });
            } catch (err) {
                if (err.name !== 'AbortError') fallbackDownload(blob, finalFileName);
            }
        } else {
            fallbackDownload(blob, finalFileName);
        }
    }

    function fallbackDownload(blob, fileName) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                cards = JSON.parse(e.target.result);
                saveAndRender();
                alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
            } catch (err) {
                alert("íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        };
        reader.readAsText(file);
    }

    function renderList() {
        const searchTerm = document.getElementById('searchBar').value.toLowerCase();
        const listDiv = document.getElementById('categoryList');
        const indexDiv = document.getElementById('indexContainer');
        listDiv.innerHTML = ''; indexDiv.innerHTML = '';

        const tagGroups = {};
        cards.forEach(card => {
            if(card.num.toLowerCase().includes(searchTerm) || card.summary.toLowerCase().includes(searchTerm)) {
                card.tags.forEach(tag => {
                    (tagGroups[tag] = tagGroups[tag] || []).push(card);
                });
            }
        });

        Object.keys(tagGroups).sort().forEach(tag => {
            const a = document.createElement('a');
            a.className = 'index-item';
            a.innerText = `${tag} (${tagGroups[tag].length})`;
            a.href = `#tag-${tag}`;
            indexDiv.appendChild(a);

            let section = `<div class="category-group" id="tag-${tag}"><h3># ${tag}</h3>`;
            tagGroups[tag].forEach(card => {
                const displaySummary = card.summary.replace(/\[\[(.*?)\]\]/g, '<b class="wiki-link">[[ $1 ]]</b>');
                section += `
                    <div class="z-card">
                        <span class="num-tag">${card.num}</span>
                        <div>${displaySummary}</div>
                        <div class="actions">
                            <button class="btn-sm" onclick="editCard(${card.id})">ìˆ˜ì •</button>
                            <button class="btn-sm btn-del" onclick="deleteCard(${card.id})">ì‚­ì œ</button>
                        </div>
                    </div>`;
            });
            listDiv.innerHTML += section + `</div>`;
        });
    }

    function editCard(id) {
        const card = cards.find(c => c.id === id);
        const n = prompt("ë²ˆí˜¸:", card.num); if(!n) return;
        const t = prompt("íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„):", card.tags.join(', '));
        const s = prompt("ë‚´ìš©:", card.summary);
        card.num = n; card.tags = t.split(',').map(i => i.trim()); card.summary = s;
        saveAndRender();
    }

    function deleteCard(id) { if(confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) { cards = cards.filter(c => c.id !== id); saveAndRender(); } }

    function drawCards() {
        const display = document.getElementById('randomDisplay');
        display.innerHTML = '';
        const count = Math.floor(Math.random() * 3) + 3;
        [...cards].sort(() => 0.5 - Math.random()).slice(0, count).forEach(c => {
            display.innerHTML += `<div class="r-card"><b>${c.num}</b><br><small>${c.summary.substring(0,25)}...</small></div>`;
        });
    }

    renderList();
</script>

</body>
</html>
